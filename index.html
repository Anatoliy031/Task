<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskOps ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞–¥–∞—á (GitHub Pages)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --panel:#101a2e;
      --panel2:#0f1a33;
      --card:#0f203f;
      --text:#e9f0ff;
      --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --good:#30d158;
      --warn:#ffd60a;
      --bad:#ff453a;
      --accent:#4da3ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background: radial-gradient(1200px 700px at 30% -10%, rgba(77,163,255,.25), transparent 60%),
                         radial-gradient(900px 700px at 90% 10%, rgba(48,209,88,.18), transparent 60%),
                         var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    a{color:var(--accent); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 14px 40px;}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      position:sticky; top:0; z-index:20;
      background: linear-gradient(to bottom, rgba(11,18,32,.92), rgba(11,18,32,.60));
      backdrop-filter: blur(10px);
      padding:14px 10px; margin:-18px -14px 18px;
      border-bottom:1px solid var(--line);
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(77,163,255,.95), rgba(48,209,88,.75));
      box-shadow: var(--shadow);
    }
    .title h1{font-size:16px;margin:0}
    .title p{margin:2px 0 0; color:var(--muted); font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button, .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 10px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      transition:.15s;
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
    }
    button:hover{transform: translateY(-1px); border-color: rgba(77,163,255,.35)}
    button.primary{background: rgba(77,163,255,.18); border-color: rgba(77,163,255,.35)}
    button.good{background: rgba(48,209,88,.16); border-color: rgba(48,209,88,.30)}
    button.bad{background: rgba(255,69,58,.14); border-color: rgba(255,69,58,.30)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.05); color:var(--muted); font-size:12px;
    }
    .grid{display:grid; gap:14px; grid-template-columns: 1.35fr .65fr}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .panel{
      background: linear-gradient(180deg, rgba(16,26,46,.85), rgba(16,26,46,.55));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .panel .hd .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .panel .hd h2{margin:0; font-size:14px}
    .panel .bd{padding:12px}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:8px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--muted)}
    .tab.active{color:var(--text); border-color: rgba(77,163,255,.38); background: rgba(77,163,255,.12)}
    .kpis{display:grid; gap:10px; grid-template-columns: repeat(4,1fr)}
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    .kpi{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:10px;
    }
    .kpi .n{font-family:var(--mono); font-size:18px}
    .kpi .l{color:var(--muted); font-size:12px; margin-top:2px}
    .kpi .b{height:6px; border-radius:999px; background: rgba(255,255,255,.08); margin-top:8px; overflow:hidden}
    .kpi .b > i{display:block; height:100%; width:20%; background: rgba(77,163,255,.8)}
    .split{display:grid; grid-template-columns: 1fr; gap:12px}
    .filters{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width: 700px){ .filters{grid-template-columns:1fr} }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius: 12px;
      padding:10px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px}
    .form{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .form .full{grid-column:1 / -1}
    .mini{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line); margin:10px 0}
    .board{display:grid; gap:12px; grid-template-columns: repeat(3,1fr)}
    @media (max-width: 980px){ .board{grid-template-columns:1fr} }
    .col{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      min-height: 260px;
    }
    .col .ch{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .col .ch .name{font-size:13px}
    .col .ch .count{font-family:var(--mono); color:var(--muted); font-size:12px}
    .dropzone{padding:10px; display:grid; gap:10px}
    .card{
      background: linear-gradient(180deg, rgba(15,32,63,.88), rgba(15,32,63,.55));
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding:10px;
      cursor:grab;
      box-shadow: 0 10px 18px rgba(0,0,0,.20);
      position:relative;
    }
    .card:active{cursor:grabbing}
    .card .t{font-size:13px; margin:0 0 6px}
    .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:11px}
    .tag{border:1px solid var(--line); background:rgba(255,255,255,.04); padding:4px 8px; border-radius:999px}
    .prio{font-weight:600}
    .prio.p1{color:var(--bad)}
    .prio.p2{color:var(--warn)}
    .prio.p3{color:var(--good)}
    .badge{
      position:absolute; top:10px; right:10px;
      border-radius:999px; padding:4px 8px;
      font-size:11px; border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .badge.overdue{border-color: rgba(255,69,58,.35); background: rgba(255,69,58,.12); color: #ffd0cc}
    .badge.soon{border-color: rgba(255,214,10,.35); background: rgba(255,214,10,.12); color: #fff3b3}
    .list{display:grid; gap:10px}
    .row{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:10px;
      display:grid;
      grid-template-columns: 1.2fr .6fr .6fr .6fr .6fr;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 980px){
      .row{grid-template-columns: 1fr; gap:6px}
    }
    .row .rtitle{font-size:13px}
    .row .rsub{font-size:12px; color:var(--muted)}
    .row .rcell{font-size:12px; color:var(--muted)}
    .row .rbtns{display:flex; gap:8px; flex-wrap:wrap}
    .ghost{opacity:.55}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .log{
      font-family: var(--mono);
      font-size: 11px;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:10px;
      max-height: 220px;
      overflow:auto;
    }
    .small{font-size:11px;color:var(--muted)}
    .toast{
      position:fixed; left:14px; right:14px; bottom:14px;
      background: rgba(16,26,46,.92);
      border:1px solid var(--line);
      border-radius: 16px;
      padding:10px 12px;
      display:none;
      box-shadow: var(--shadow);
      z-index: 50;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>TaskOps ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h1>
          <p>–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º (LocalStorage) ‚Ä¢ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ ‚Ä¢ –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è GitHub Pages</p>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="nowPill">‚Äî</span>
        <button class="primary" id="btnNew">+ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
        <button id="btnNotify">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
        <button id="btnExport">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button id="btnImport">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç</button>
        <button class="bad" id="btnReset">–°–±—Ä–æ—Å</button>
      </div>
    </header>

    <div class="grid">
      <!-- MAIN -->
      <section class="panel">
        <div class="hd">
          <div class="left">
            <h2>–†–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</h2>
            <div class="tabs">
              <button class="tab active" data-tab="board">–ö–∞–Ω–±–∞–Ω</button>
              <button class="tab" data-tab="list">–°–ø–∏—Å–æ–∫</button>
              <button class="tab" data-tab="analytics">–ö–æ–Ω—Ç—Ä–æ–ª—å</button>
            </div>
          </div>

          <div class="left" style="gap:8px">
            <span class="pill">–ê–≤—Ç–æ–ø—Ä–æ—Ü–µ—Å—Å—ã: <b id="autoState">–≤–∫–ª</b></span>
            <button class="good" id="btnRunAutomation">‚ñ∂ –ü—Ä–æ–≥–Ω–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É</button>
          </div>
        </div>

        <div class="bd">
          <!-- Filters -->
          <div class="filters" style="margin-bottom:12px">
            <div>
              <label>–ü–æ–∏—Å–∫</label>
              <input id="q" placeholder="—Ç–µ–∫—Å—Ç, —Ç–µ–≥, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π‚Ä¶" />
            </div>
            <div>
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select id="fStatus">
                <option value="">–í—Å–µ</option>
                <option value="todo">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                <option value="doing">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
              </select>
            </div>
            <div>
              <label>–ü–æ–∫–∞–∑</label>
              <select id="fShow">
                <option value="all">–í—Å–µ –∑–∞–¥–∞—á–∏</option>
                <option value="overdue">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</option>
                <option value="today">–°—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è</option>
                <option value="week">–°—Ä–æ–∫ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π</option>
              </select>
            </div>
          </div>

          <!-- TAB: BOARD -->
          <div id="tab-board">
            <div class="board">
              <div class="col" data-status="todo">
                <div class="ch">
                  <div class="name">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</div>
                  <div class="count" id="c_todo">0</div>
                </div>
                <div class="dropzone" id="dz_todo"></div>
              </div>

              <div class="col" data-status="doing">
                <div class="ch">
                  <div class="name">–í —Ä–∞–±–æ—Ç–µ</div>
                  <div class="count" id="c_doing">0</div>
                </div>
                <div class="dropzone" id="dz_doing"></div>
              </div>

              <div class="col" data-status="done">
                <div class="ch">
                  <div class="name">–ì–æ—Ç–æ–≤–æ</div>
                  <div class="count" id="c_done">0</div>
                </div>
                <div class="dropzone" id="dz_done"></div>
              </div>
            </div>

            <div class="divider"></div>
            <div class="hint">
              <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äú–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞‚Äù:</b>
              <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted)">
                <li>–ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–∫—É / ‚Äú—Å–∫–æ—Ä–æ —Å—Ä–æ–∫‚Äù.</li>
                <li>–°–æ–∑–¥–∞—ë—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ/–µ–∂–µ–º–µ—Å—è—á–Ω–æ) –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–µ–π.</li>
                <li>–í–µ–¥—ë—Ç –∂—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π (–∞—É–¥–∏—Ç).</li>
                <li>–ú–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ).</li>
              </ul>
            </div>
          </div>

          <!-- TAB: LIST -->
          <div id="tab-list" style="display:none">
            <div class="list" id="list"></div>
          </div>

          <!-- TAB: ANALYTICS -->
          <div id="tab-analytics" style="display:none">
            <div class="kpis">
              <div class="kpi">
                <div class="n" id="k_all">0</div>
                <div class="l">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                <div class="b"><i id="b_all"></i></div>
              </div>
              <div class="kpi">
                <div class="n" id="k_done">0</div>
                <div class="l">–ì–æ—Ç–æ–≤–æ</div>
                <div class="b"><i id="b_done"></i></div>
              </div>
              <div class="kpi">
                <div class="n" id="k_overdue">0</div>
                <div class="l">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
                <div class="b"><i id="b_overdue"></i></div>
              </div>
              <div class="kpi">
                <div class="n" id="k_due7">0</div>
                <div class="l">–°—Ä–æ–∫ ‚â§ 7 –¥–Ω–µ–π</div>
                <div class="b"><i id="b_due7"></i></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="split">
              <div>
                <h3 style="margin:0 0 8px; font-size:13px">–ñ—É—Ä–Ω–∞–ª –∫–æ–Ω—Ç—Ä–æ–ª—è (audit log)</h3>
                <div class="log" id="log"></div>
                <div class="small" style="margin-top:8px">
                  –°–æ–≤–µ—Ç: —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –∫–∞–∫ –±—ç–∫–∞–ø. –≠—Ç–æ —É–¥–æ–±–Ω–æ, –µ—Å–ª–∏ —Å–∞–π—Ç –∫—Ä—É—Ç–∏—Ç—Å—è –Ω–∞ GitHub Pages –∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.
                </div>
              </div>

              <div>
                <h3 style="margin:0 0 8px; font-size:13px">–†–µ–≥–ª–∞–º–µ–Ω—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è (—à–∞–±–ª–æ–Ω)</h3>
                <div class="hint">
                  <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted)">
                    <li><b>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</b>: —Ñ–∏–ª—å—Ç—Ä ‚Äú–°—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è‚Äù ‚Üí –∑–∞–∫—Ä—ã—Ç—å/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å.</li>
                    <li><b>–ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</b>: —Ñ–∏–ª—å—Ç—Ä ‚Äú‚â§ 7 –¥–Ω–µ–π‚Äù ‚Üí –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.</li>
                    <li><b>–ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏</b>: ‚Äú–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ‚Äù ‚Üí –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏—á–∏–Ω—ã –∏ –Ω–æ–≤–∞—è –¥–∞—Ç–∞.</li>
                    <li><b>–ê–≤—Ç–æ–ø–æ–≤—Ç–æ—Ä—ã</b>: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ‚Äú–ü–æ–≤—Ç–æ—Ä‚Äù –¥–ª—è —Ä—É—Ç–∏–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (–æ—Ç—á—ë—Ç—ã, –ø—Ä–æ–≤–µ—Ä–∫–∏, –æ–ø–ª–∞—Ç—ã).</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- SIDE -->
      <aside class="panel" id="sidePanel">
        <div class="hd">
          <div class="left">
            <h2 id="formTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
          </div>
          <div class="left">
            <button id="btnCloseForm">‚úï</button>
          </div>
        </div>

        <div class="bd">
          <div class="form">
            <div class="full">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input id="t_title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç / –ü–æ–∑–≤–æ–Ω–∏—Ç—å / –ü—Ä–æ–≤–µ—Ä–∏—Ç—å‚Ä¶" />
            </div>

            <div class="full">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea id="t_desc" placeholder="–°—É—Ç—å, –∫—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, —Å—Å—ã–ª–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã‚Ä¶"></textarea>
            </div>

            <div>
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select id="t_status">
                <option value="todo">–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                <option value="doing">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
              </select>
            </div>

            <div>
              <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
              <select id="t_prio">
                <option value="1">P1 ‚Äî —Å—Ä–æ—á–Ω–æ</option>
                <option value="2" selected>P2 ‚Äî –≤–∞–∂–Ω–æ</option>
                <option value="3">P3 ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ</option>
              </select>
            </div>

            <div>
              <label>–°—Ä–æ–∫ (–¥–∞—Ç–∞)</label>
              <input id="t_due" type="date" />
            </div>

            <div>
              <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <input id="t_owner" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ø / –ò–≤–∞–Ω / –û—Ç–¥–µ–ª‚Ä¶" />
            </div>

            <div class="full">
              <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
              <input id="t_tags" placeholder="–≤–æ–ª—Å, —é—Ä, —Ñ–∏–Ω–∞–Ω—Å—ã, –¥–æ–º, —Å–µ–º—å—è‚Ä¶" />
            </div>

            <div class="full">
              <label>–ß–µ–∫–ª–∏—Å—Ç (–∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
              <textarea id="t_check" placeholder="1) ‚Ä¶&#10;2) ‚Ä¶&#10;3) ‚Ä¶"></textarea>
              <div class="mini">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫–ª–∏—Å—Ç–∞ –æ—Ç–º–µ—á–µ–Ω—ã ‚Äî –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –∑–∞–¥–∞—á—É –≤ 1 –∫–ª–∏–∫.</div>
            </div>

            <div class="full">
              <label>–ü–æ–≤—Ç–æ—Ä (–∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù)</label>
              <select id="t_repeat">
                <option value="">–ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å</option>
                <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
              </select>
              <div class="mini">–ü—Ä–∏–º–µ—Ä: ‚Äú–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ‚Äù + —Å—Ä–æ–∫ = –±–ª–∏–∂–∞–π—à–∞—è –ø—è—Ç–Ω–∏—Ü–∞ ‚Üí –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–∑–¥–∞—Å—Ç—Å—è —Å–ª–µ–¥—É—é—â–∞—è —Å –Ω–æ–≤—ã–º —Å—Ä–æ–∫–æ–º.</div>
            </div>

            <div class="full" style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="primary" id="btnSave">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="good" id="btnMarkDone">‚úÖ –ó–∞–∫—Ä—ã—Ç—å</button>
              <button class="bad" id="btnDelete">üóë –£–¥–∞–ª–∏—Ç—å</button>
            </div>

            <div class="full">
              <div class="divider"></div>
              <div class="hint">
                <b>–ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–æ):</b>
                <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted)">
                  <li>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ñ–∏–ª—å—Ç—Ä ‚Äú–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ‚Äù.</li>
                  <li>–ï—Å–ª–∏ —Å—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ ‚Äî –ø–æ–º–µ—Ç–∫–∞ ‚Äú—Å–∫–æ—Ä–æ —Å—Ä–æ–∫‚Äù.</li>
                  <li>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è.</li>
                  <li>–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π –ø–∏—à–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ/–ø—Ä–∞–≤–∫–∞/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ).</li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </aside>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <input id="fileInput" type="file" accept="application/json" hidden />

  <script>
    /***********************
     * TaskOps ‚Äî Single-file app
     * Storage: LocalStorage
     * Works on GitHub Pages (no backend)
     ***********************/

    const LS_KEY = "taskops.v1.data";
    const LS_LOG = "taskops.v1.log";
    const SOON_DAYS = 1; // —Å—Ä–æ–∫ "—Å–∫–æ—Ä–æ" = —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞ (1 –¥–µ–Ω—å –≤–ø–µ—Ä—ë–¥)

    /** @type {Array<Task>} */
    let tasks = [];
    let editingId = null;

    /** Utils */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
    const todayISO = () => new Date().toISOString().slice(0,10);

    function parseDateISO(d){
      if(!d) return null;
      const t = new Date(d+"T00:00:00");
      return isNaN(t.getTime()) ? null : t;
    }
    function daysBetween(a,b){
      // b - a, in days
      const ms = (b - a);
      return Math.floor(ms / (1000*60*60*24));
    }
    function addDaysISO(dateISO, days){
      const d = parseDateISO(dateISO || todayISO()) || new Date();
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    function addPeriodISO(dateISO, period){
      // period: daily/weekly/monthly
      const d = parseDateISO(dateISO || todayISO()) || new Date();
      if(period === "daily") d.setDate(d.getDate() + 1);
      if(period === "weekly") d.setDate(d.getDate() + 7);
      if(period === "monthly") d.setMonth(d.getMonth() + 1);
      return d.toISOString().slice(0,10);
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2600);
    }
    function log(msg){
      const ts = new Date().toLocaleString("ru-RU");
      const line = `[${ts}] ${msg}`;
      const arr = loadLog();
      arr.unshift(line);
      localStorage.setItem(LS_LOG, JSON.stringify(arr.slice(0,400)));
      renderLog();
    }
    function loadLog(){
      try{ return JSON.parse(localStorage.getItem(LS_LOG) || "[]"); }catch{ return []; }
    }

    /** Data model */
    function normalizeTask(t){
      return {
        id: t.id || uid(),
        title: (t.title || "").trim(),
        desc: t.desc || "",
        status: t.status || "todo", // todo|doing|done
        prio: String(t.prio || "2"), // 1|2|3
        due: t.due || "", // YYYY-MM-DD
        owner: t.owner || "",
        tags: Array.isArray(t.tags) ? t.tags : (t.tags ? String(t.tags).split(",").map(s=>s.trim()).filter(Boolean) : []),
        checklist: Array.isArray(t.checklist) ? t.checklist : [],
        repeat: t.repeat || "", // ""|daily|weekly|monthly
        createdAt: t.createdAt || Date.now(),
        updatedAt: Date.now(),
        lastDoneAt: t.lastDoneAt || null
      };
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(tasks));
      renderAll();
    }
    function load(){
      try{
        const raw = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        tasks = raw.map(normalizeTask);
      }catch{
        tasks = [];
      }

      if(tasks.length === 0){
        // seed examples
        tasks = [
          normalizeTask({
            title:"–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å: –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –∏ —Å—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è",
            desc:"–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä ‚Äú–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ‚Äù –∏ ‚Äú–°—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è‚Äù. –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å.",
            status:"todo", prio:"1", due: todayISO(), tags:["–∫–æ–Ω—Ç—Ä–æ–ª—å"], owner:"–Ø", repeat:"daily",
            checklist:[{text:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏",done:false},{text:"–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫ —Å–µ–≥–æ–¥–Ω—è",done:false}]
          }),
          normalizeTask({
            title:"–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω: –∑–∞–¥–∞—á–∏ –Ω–∞ 7 –¥–Ω–µ–π",
            desc:"–ü–æ —Ñ–∏–ª—å—Ç—Ä—É ‚Äú‚â§ 7 –¥–Ω–µ–π‚Äù —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö, —É—Ç–æ—á–Ω–∏—Ç—å —Å—Ä–æ–∫–∏.",
            status:"todo", prio:"2", due: addDaysISO(todayISO(), 3), tags:["–ø–ª–∞–Ω"], owner:"–Ø", repeat:"weekly"
          }),
          normalizeTask({
            title:"–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)",
            desc:"–ö–Ω–æ–ø–∫–∞ üîî ‚Üí —Ä–∞–∑—Ä–µ—à–∏—Ç—å. –¢–æ–≥–¥–∞ –ø—Ä–æ—Å—Ä–æ—á–∫–∞/—Å–∫–æ—Ä–æ —Å—Ä–æ–∫ –±—É–¥—É—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å—Å—è.",
            status:"doing", prio:"3", due: addDaysISO(todayISO(), 1), tags:["—Å–∏—Å—Ç–µ–º–∞"], owner:"–Ø"
          })
        ];
        localStorage.setItem(LS_KEY, JSON.stringify(tasks));
        log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞–Ω —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á.");
      }
    }

    /** Filtering */
    function matchesFilters(t){
      const q = ($("#q").value || "").trim().toLowerCase();
      const fStatus = $("#fStatus").value;
      const fShow = $("#fShow").value;

      if(fStatus && t.status !== fStatus) return false;

      if(q){
        const hay = [
          t.title, t.desc, t.owner,
          ...(t.tags || []).join(" "),
          ...(t.checklist||[]).map(x=>x.text).join(" ")
        ].join(" ").toLowerCase();
        if(!hay.includes(q)) return false;
      }

      const now = parseDateISO(todayISO());
      const due = parseDateISO(t.due);

      if(fShow === "overdue"){
        if(!(due && t.status !== "done" && due < now)) return false;
      }
      if(fShow === "today"){
        if(!(t.due === todayISO())) return false;
      }
      if(fShow === "week"){
        if(!(due && daysBetween(now, due) >= 0 && daysBetween(now, due) <= 7)) return false;
      }

      return true;
    }

    /** Automation Engine */
    function computeFlags(t){
      const now = parseDateISO(todayISO());
      const due = parseDateISO(t.due);
      const flags = {overdue:false, soon:false, dueIn:null};

      if(due){
        const diff = daysBetween(now, due);
        flags.dueIn = diff;
        if(t.status !== "done" && diff < 0) flags.overdue = true;
        if(t.status !== "done" && diff >= 0 && diff <= SOON_DAYS) flags.soon = true;
      }
      return flags;
    }

    function runAutomation({silent=false}={}){
      // 1) Create next recurring tasks if completed
      // rule: if repeat != "" and status==done and (lastDoneAt recent) => create next and clear repeat on old? keep repeat on old
      let created = 0;
      for(const t of tasks){
        if(!t.repeat) continue;
        if(t.status !== "done") continue;

        // prevent duplicate creation: if already created after this completion
        // we store lastDoneAt on completion; and store on task: _spawnedFromDoneAt marker
        if(!t.lastDoneAt) continue;
        if(t._spawnedFromDoneAt === t.lastDoneAt) continue;

        // create next task
        const next = normalizeTask({
          title: t.title,
          desc: t.desc,
          status: "todo",
          prio: t.prio,
          due: t.due ? addPeriodISO(t.due, t.repeat) : addPeriodISO(todayISO(), t.repeat),
          owner: t.owner,
          tags: t.tags,
          repeat: t.repeat,
          checklist: (t.checklist||[]).map(x=>({text:x.text, done:false}))
        });
        next._generatedBy = t.id;

        tasks.push(next);
        t._spawnedFromDoneAt = t.lastDoneAt;
        created++;
        log(`–ê–≤—Ç–æ: —Å–æ–∑–¥–∞–Ω –ø–æ–≤—Ç–æ—Ä "${next.title}" (—Å—Ä–æ–∫ ${next.due || "‚Äî"})`);
      }

      // 2) Notify for overdue/soon (if permission)
      const notifyOk = (typeof Notification !== "undefined" && Notification.permission === "granted");
      if(notifyOk){
        const now = parseDateISO(todayISO());
        const dueSoon = tasks.filter(t=>{
          const f = computeFlags(t);
          return (f.overdue || f.soon) && t.status !== "done";
        });

        // throttle: notify not more often than every 60 minutes
        const last = Number(localStorage.getItem("taskops.v1.lastNotify") || "0");
        const sinceMin = (Date.now() - last) / 60000;

        if(dueSoon.length && sinceMin >= 60){
          const overdueCount = dueSoon.filter(t=>computeFlags(t).overdue).length;
          const soonCount = dueSoon.filter(t=>computeFlags(t).soon).length;

          new Notification("TaskOps: –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–æ–∫–æ–≤", {
            body: `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ${overdueCount}, —Å–∫–æ—Ä–æ —Å—Ä–æ–∫: ${soonCount}. –û—Ç–∫—Ä–æ–π—Ç–µ TaskOps –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`,
            silent: true
          });
          localStorage.setItem("taskops.v1.lastNotify", String(Date.now()));
        }
      }

      if(!silent){
        save();
        toast(created ? `–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞: —Å–æ–∑–¥–∞–Ω–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ ‚Äî ${created}` : "–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞: –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç");
      }else{
        save();
      }
    }

    /** Rendering */
    function prioLabel(p){
      if(p==="1") return "P1";
      if(p==="2") return "P2";
      return "P3";
    }
    function statusLabel(s){
      if(s==="todo") return "–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é";
      if(s==="doing") return "–í —Ä–∞–±–æ—Ç–µ";
      return "–ì–æ—Ç–æ–≤–æ";
    }

    function cardHTML(t){
      const f = computeFlags(t);
      const dueTxt = t.due ? `–°—Ä–æ–∫: ${t.due}` : "–°—Ä–æ–∫: ‚Äî";
      const tags = (t.tags||[]).slice(0,4).map(x=>`<span class="tag">#${escapeHtml(x)}</span>`).join("");
      const badge = f.overdue ? `<span class="badge overdue">–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>` :
                    f.soon ? `<span class="badge soon">—Å–∫–æ—Ä–æ —Å—Ä–æ–∫</span>` : "";
      return `
        <div class="card" draggable="true" data-id="${t.id}">
          ${badge}
          <div class="t">${escapeHtml(t.title || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)")}</div>
          <div class="meta">
            <span class="tag prio ${t.prio==="1"?"p1":t.prio==="2"?"p2":"p3"}">${prioLabel(t.prio)}</span>
            <span class="tag">${escapeHtml(dueTxt)}</span>
            ${t.owner ? `<span class="tag">üë§ ${escapeHtml(t.owner)}</span>` : ""}
            ${tags}
          </div>
        </div>
      `;
    }

    function renderBoard(){
      const dzTodo = $("#dz_todo");
      const dzDoing = $("#dz_doing");
      const dzDone = $("#dz_done");
      dzTodo.innerHTML = "";
      dzDoing.innerHTML = "";
      dzDone.innerHTML = "";

      const filtered = tasks.filter(matchesFilters);

      const todo = filtered.filter(t=>t.status==="todo");
      const doing = filtered.filter(t=>t.status==="doing");
      const done = filtered.filter(t=>t.status==="done");

      $("#c_todo").textContent = String(todo.length);
      $("#c_doing").textContent = String(doing.length);
      $("#c_done").textContent = String(done.length);

      todo.sort(sorter).forEach(t=>dzTodo.insertAdjacentHTML("beforeend", cardHTML(t)));
      doing.sort(sorter).forEach(t=>dzDoing.insertAdjacentHTML("beforeend", cardHTML(t)));
      done.sort(sorter).forEach(t=>dzDone.insertAdjacentHTML("beforeend", cardHTML(t)));

      // drag handlers
      $$(".card").forEach(el=>{
        el.addEventListener("dragstart", (e)=>{
          e.dataTransfer.setData("text/plain", el.dataset.id);
          setTimeout(()=>el.classList.add("ghost"), 0);
        });
        el.addEventListener("dragend", ()=>{
          el.classList.remove("ghost");
        });
        el.addEventListener("click", ()=>{
          openEditor(el.dataset.id);
        });
      });

      $$(".col").forEach(col=>{
        col.addEventListener("dragover", (e)=>{ e.preventDefault(); });
        col.addEventListener("drop", (e)=>{
          e.preventDefault();
          const id = e.dataTransfer.getData("text/plain");
          const status = col.dataset.status;
          moveTask(id, status);
        });
      });
    }

    function sorter(a,b){
      // overdue first, then prio, then due asc, then updated desc
      const fa = computeFlags(a), fb = computeFlags(b);
      if(fa.overdue && !fb.overdue) return -1;
      if(!fa.overdue && fb.overdue) return 1;

      if(a.prio !== b.prio) return Number(a.prio) - Number(b.prio);

      const da = a.due ? a.due : "9999-12-31";
      const db = b.due ? b.due : "9999-12-31";
      if(da !== db) return da.localeCompare(db);

      return (b.updatedAt||0) - (a.updatedAt||0);
    }

    function renderList(){
      const el = $("#list");
      el.innerHTML = "";
      const filtered = tasks.filter(matchesFilters).sort(sorter);
      if(!filtered.length){
        el.innerHTML = `<div class="hint">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º.</div>`;
        return;
      }

      for(const t of filtered){
        const f = computeFlags(t);
        const due = t.due || "‚Äî";
        const ov = f.overdue ? " ‚Ä¢ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ" : f.soon ? " ‚Ä¢ —Å–∫–æ—Ä–æ —Å—Ä–æ–∫" : "";
        el.insertAdjacentHTML("beforeend", `
          <div class="row">
            <div>
              <div class="rtitle">${escapeHtml(t.title || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)")}</div>
              <div class="rsub">${escapeHtml((t.tags||[]).map(x=>"#"+x).join(" "))}</div>
            </div>
            <div class="rcell">–°—Ç–∞—Ç—É—Å: <b>${statusLabel(t.status)}</b></div>
            <div class="rcell">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: <b>${prioLabel(t.prio)}</b></div>
            <div class="rcell">–°—Ä–æ–∫: <b>${escapeHtml(due)}</b><span style="color:var(--muted)">${ov}</span></div>
            <div class="rbtns">
              <button class="primary" data-open="${t.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="good" data-done="${t.id}">–ì–æ—Ç–æ–≤–æ</button>
            </div>
          </div>
        `);
      }

      $$("button[data-open]").forEach(b=>b.addEventListener("click",()=>openEditor(b.dataset.open)));
      $$("button[data-done]").forEach(b=>b.addEventListener("click",()=>markDone(b.dataset.done)));
    }

    function renderKPIs(){
      const all = tasks.length;
      const done = tasks.filter(t=>t.status==="done").length;
      const now = parseDateISO(todayISO());
      const overdue = tasks.filter(t=>{
        const d = parseDateISO(t.due);
        return d && t.status!=="done" && d < now;
      }).length;
      const due7 = tasks.filter(t=>{
        const d = parseDateISO(t.due);
        if(!d || t.status==="done") return false;
        const diff = daysBetween(now, d);
        return diff >= 0 && diff <= 7;
      }).length;

      $("#k_all").textContent = String(all);
      $("#k_done").textContent = String(done);
      $("#k_overdue").textContent = String(overdue);
      $("#k_due7").textContent = String(due7);

      const pct = (n)=> all ? Math.round((n/all)*100) : 0;
      $("#b_all").style.width = "100%";
      $("#b_done").style.width = pct(done) + "%";
      $("#b_overdue").style.width = pct(overdue) + "%";
      $("#b_due7").style.width = pct(due7) + "%";
    }

    function renderLog(){
      const arr = loadLog();
      $("#log").textContent = arr.length ? arr.join("\n") : "–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç.";
    }

    function renderAll(){
      renderBoard();
      renderList();
      renderKPIs();
      renderLog();
    }

    /** Editor */
    function clearForm(){
      editingId = null;
      $("#formTitle").textContent = "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞";
      $("#t_title").value = "";
      $("#t_desc").value = "";
      $("#t_status").value = "todo";
      $("#t_prio").value = "2";
      $("#t_due").value = "";
      $("#t_owner").value = "";
      $("#t_tags").value = "";
      $("#t_check").value = "";
      $("#t_repeat").value = "";
      $("#btnDelete").disabled = true;
      $("#btnMarkDone").disabled = false;
    }

    function openEditor(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;

      editingId = id;
      $("#formTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
      $("#t_title").value = t.title || "";
      $("#t_desc").value = t.desc || "";
      $("#t_status").value = t.status || "todo";
      $("#t_prio").value = t.prio || "2";
      $("#t_due").value = t.due || "";
      $("#t_owner").value = t.owner || "";
      $("#t_tags").value = (t.tags||[]).join(", ");
      $("#t_repeat").value = t.repeat || "";
      $("#t_check").value = (t.checklist||[]).map(x=>(x.done?"[x] ":"[ ] ")+x.text).join("\n");

      $("#btnDelete").disabled = false;
      $("#btnMarkDone").disabled = (t.status==="done");
    }

    function readChecklist(text){
      const lines = String(text||"").split("\n").map(s=>s.trim()).filter(Boolean);
      // allow [x] [ ] or plain
      return lines.map(line=>{
        const m = line.match(/^\[(x| )\]\s*(.*)$/i);
        if(m) return {done: m[1].toLowerCase()==="x", text: (m[2]||"").trim()};
        return {done:false, text: line.replace(/^[-‚Ä¢\d\)\.]+\s*/,"").trim()};
      }).filter(x=>x.text);
    }

    function upsertFromForm(){
      const data = normalizeTask({
        id: editingId || uid(),
        title: $("#t_title").value,
        desc: $("#t_desc").value,
        status: $("#t_status").value,
        prio: $("#t_prio").value,
        due: $("#t_due").value,
        owner: $("#t_owner").value,
        tags: $("#t_tags").value,
        repeat: $("#t_repeat").value,
        checklist: readChecklist($("#t_check").value),
        createdAt: editingId ? (tasks.find(x=>x.id===editingId)?.createdAt || Date.now()) : Date.now(),
        lastDoneAt: tasks.find(x=>x.id===editingId)?.lastDoneAt || null
      });

      if(!data.title){
        toast("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏.");
        return;
      }

      if(editingId){
        const idx = tasks.findIndex(x=>x.id===editingId);
        tasks[idx] = {...tasks[idx], ...data, updatedAt: Date.now()};
        log(`–ü—Ä–∞–≤–∫–∞: "${data.title}"`);
      }else{
        tasks.push({...data, createdAt: Date.now(), updatedAt: Date.now()});
        log(`–°–æ–∑–¥–∞–Ω–∏–µ: "${data.title}"`);
      }

      save();
      toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
      openEditor(data.id);
    }

    function moveTask(id, newStatus){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;
      if(t.status === newStatus) return;

      t.status = newStatus;
      t.updatedAt = Date.now();

      if(newStatus === "done" && !t.lastDoneAt){
        t.lastDoneAt = Date.now();
      }
      if(newStatus !== "done"){
        // if reopened, clear done marker to allow new completion event
        t.lastDoneAt = null;
      }

      log(`–°—Ç–∞—Ç—É—Å: "${t.title}" ‚Üí ${statusLabel(newStatus)}`);
      save();

      // run automation quickly (recurring)
      runAutomation({silent:true});
    }

    function markDone(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;
      t.status = "done";
      t.updatedAt = Date.now();
      t.lastDoneAt = Date.now();
      log(`–ó–∞–∫—Ä—ã—Ç–æ: "${t.title}"`);
      save();
      runAutomation({silent:false});
      if(editingId === id) openEditor(id);
    }

    function deleteTask(){
      if(!editingId) return;
      const t = tasks.find(x=>x.id===editingId);
      if(!t) return;

      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${t.title}"?`)) return;
      tasks = tasks.filter(x=>x.id!==editingId);
      log(`–£–¥–∞–ª–µ–Ω–æ: "${t.title}"`);
      save();
      clearForm();
      toast("–£–¥–∞–ª–µ–Ω–æ");
    }

    /** Export/Import */
    function download(filename, text){
      const blob = new Blob([text], {type:"application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportData(){
      const payload = {
        meta: {app:"TaskOps", version:"1.0", exportedAt: new Date().toISOString()},
        tasks,
        log: loadLog()
      };
      download(`taskops_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
      toast("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ JSON");
    }

    function importData(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const payload = JSON.parse(String(reader.result||"{}"));
          if(payload && Array.isArray(payload.tasks)){
            tasks = payload.tasks.map(normalizeTask);
            localStorage.setItem(LS_KEY, JSON.stringify(tasks));
            if(Array.isArray(payload.log)) localStorage.setItem(LS_LOG, JSON.stringify(payload.log));
            log("–ò–º–ø–æ—Ä—Ç: –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            renderAll();
            toast("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
          }else{
            toast("–§–∞–π–ª –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –±—ç–∫–∞–ø TaskOps.");
          }
        }catch{
          toast("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    /** Notifications */
    async function requestNotify(){
      if(typeof Notification === "undefined"){
        toast("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
        return;
      }
      if(Notification.permission === "granted"){
        toast("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã.");
        return;
      }
      const p = await Notification.requestPermission();
      toast(p === "granted" ? "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã." : "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã.");
    }

    /** Tabs */
    function setTab(name){
      $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
      $("#tab-board").style.display = (name==="board") ? "" : "none";
      $("#tab-list").style.display = (name==="list") ? "" : "none";
      $("#tab-analytics").style.display = (name==="analytics") ? "" : "none";
      renderAll();
    }

    /** HTML escape */
    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /** Clock */
    function tickNow(){
      const d = new Date();
      $("#nowPill").textContent = d.toLocaleString("ru-RU", {weekday:"short", day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit"});
    }

    /** Events */
    function bind(){
      $("#btnNew").addEventListener("click", ()=>{
        clearForm();
        toast("–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.");
      });
      $("#btnCloseForm").addEventListener("click", ()=>{
        // just clear for now
        clearForm();
      });
      $("#btnSave").addEventListener("click", upsertFromForm);
      $("#btnDelete").addEventListener("click", deleteTask);
      $("#btnMarkDone").addEventListener("click", ()=>{
        if(!editingId) return;
        markDone(editingId);
      });

      $("#btnExport").addEventListener("click", exportData);
      $("#btnImport").addEventListener("click", ()=> $("#fileInput").click());
      $("#fileInput").addEventListener("change", (e)=>{
        const f = e.target.files && e.target.files[0];
        if(f) importData(f);
        e.target.value = "";
      });

      $("#btnReset").addEventListener("click", ()=>{
        if(!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏ –∂—É—Ä–Ω–∞–ª?")) return;
        localStorage.removeItem(LS_KEY);
        localStorage.removeItem(LS_LOG);
        localStorage.removeItem("taskops.v1.lastNotify");
        load();
        log("–°–±—Ä–æ—Å: –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.");
        renderAll();
        clearForm();
        toast("–°–±—Ä–æ—à–µ–Ω–æ");
      });

      $("#btnNotify").addEventListener("click", requestNotify);

      $$(".tab").forEach(btn=>{
        btn.addEventListener("click", ()=>setTab(btn.dataset.tab));
      });

      // filters
      ["q","fStatus","fShow"].forEach(id=>{
        $("#"+id).addEventListener("input", renderAll);
        $("#"+id).addEventListener("change", renderAll);
      });

      $("#btnRunAutomation").addEventListener("click", ()=>runAutomation({silent:false}));

      // keyboard shortcuts
      window.addEventListener("keydown", (e)=>{
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
          e.preventDefault();
          $("#q").focus();
        }
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="n"){
          e.preventDefault();
          clearForm();
          $("#t_title").focus();
        }
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
          e.preventDefault();
          upsertFromForm();
        }
      });
    }

    /** Boot */
    function boot(){
      load();
      bind();
      clearForm();
      renderAll();
      tickNow();
      setInterval(tickNow, 1000 * 10);

      // periodic automation (every 5 min)
      setInterval(()=>runAutomation({silent:true}), 1000 * 60 * 5);
      runAutomation({silent:true});
    }

    boot();
  </script>

  <!--
    –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ GitHub Pages:
    1) –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä taskops).
    2) –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª index.html (—ç—Ç–æ—Ç —Ñ–∞–π–ª) –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
    3) Settings ‚Üí Pages ‚Üí Build and deployment ‚Üí Source: Deploy from a branch
       Branch: main / root.
    4) –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É Pages ‚Äî –≥–æ—Ç–æ–≤–æ.
  -->
</body>
</html>
