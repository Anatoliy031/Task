<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–î–†–ù–£ ‚Äî —Ç—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á</title>
  <style>
    :root {
      /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞: —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ —Å –∞–∫—Ü–µ–Ω—Ç–∞–º–∏ */
      --bg: #0e162b;
      --card: #16233d;
      --accent: #5aa9fa;
      --text: #e5ebf7;
      --muted: #93a2c0;
      --bad: #f87171;
      --warn: #fbbf24;
      --good: #34d399;
      --danger: #f43f5e;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(0,0,0,0.35);
      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #app {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ / summary */
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .summary-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
    }
    .chip .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      background: var(--muted);
    }
    .dot.bad { background: var(--bad); }
    .dot.warn { background: var(--warn); }
    .dot.good { background: var(--good); }
    .dot.neutral { background: var(--accent); }
    .status-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: var(--card);
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      align-items: center;
    }
    .filters input[type="text"] {
      flex: 1;
      padding: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    .filter-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .filter-chip {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      cursor: pointer;
      user-select: none;
    }
    .filter-chip.active {
      background: rgba(90,169,250,0.25);
      border-color: rgba(90,169,250,0.6);
    }
    .me-select {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .me-select select {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: 6px 8px;
      color: var(--text);
      font-size: 12px;
      outline: none;
    }
    /* –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á */
    #task-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .task-card {
      padding: 12px;
      border-radius: var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }
    .task-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .task-id {
      font-family: monospace;
      font-size: 12px;
      color: var(--muted);
    }
    .due-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.05);
    }
    .due-badge.bad { border-color: rgba(248,113,113,0.5); background: rgba(248,113,113,0.15); }
    .due-badge.warn { border-color: rgba(251,191,36,0.5); background: rgba(251,191,36,0.15); }
    .due-badge.good { border-color: rgba(52,211,153,0.5); background: rgba(52,211,153,0.15); }
    .task-desc {
      font-size: 14px;
      line-height: 1.35;
    }
    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .task-actions button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 18px;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
    }
    .task-actions button.danger { color: var(--danger); }
    .task-actions button.done { color: var(--good); }
    /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    #add-task-btn {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius);
      background: var(--accent);
      color: #0e162b;
      font-weight: bold;
      font-size: 16px;
      border: none;
      cursor: pointer;
      box-shadow: var(--shadow);
      margin-top: auto;
    }
    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }
    .modal.open { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-content h2 {
      margin: 0;
      font-size: 18px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .form-group textarea,
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-actions button {
      padding: 8px 12px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-cancel {
      background: rgba(255,255,255,0.1);
      color: var(--text);
    }
    .btn-save {
      background: var(--accent);
      color: #0e162b;
    }
    /* –°–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */
    .saving-indicator {
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 560px) {
      .header, .filters {
        flex-direction: column;
        align-items: flex-start;
      }
      .me-select {
        margin-left: 0;
        width: 100%;
        margin-top: 6px;
      }
      #add-task-btn {
        position: sticky;
        bottom: 10px;
        z-index: 10;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div>
        <h1>–ó–∞–¥–∞—á–∏ –î–†–ù–£</h1>
        <div class="summary-chips" id="summary"></div>
      </div>
      <div class="me-select">
        <span>–Ø:</span>
        <select id="meSelect"></select>
      </div>
      <div class="saving-indicator" id="statusLine"></div>
    </div>
    <div class="filters">
      <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º..." />
      <div class="filter-chips" id="filterChips"></div>
    </div>
    <div id="task-list"></div>
    <button id="add-task-btn">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <form id="taskForm">
        <input type="hidden" id="taskId" />
        <div class="form-group">
          <label for="taskText">–ó–∞–¥–∞—á–∞</label>
          <textarea id="taskText" required placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" maxlength="500"></textarea>
        </div>
        <div class="form-group">
          <label for="taskOwner">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
          <select id="taskOwner"></select>
        </div>
        <div class="form-group">
          <label for="taskDue">–°—Ä–æ–∫</label>
          <input type="date" id="taskDue" />
        </div>
        <div class="form-group">
          <label for="taskStatus">–°—Ç–∞—Ç—É—Å</label>
          <select id="taskStatus">
            <option value="–í –ø–ª–∞–Ω">–í –ø–ª–∞–Ω</option>
            <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="–ì–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskNext">–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</label>
          <input id="taskNext" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å / –æ—Ç–ø—Ä–∞–≤–∏—Ç—å..." />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelBtn">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn-save" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  <script>
  (function(){
    'use strict';
    /*
      –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ 'token' –≤–∞—à–∏–º PAT —Å –ø—Ä–∞–≤–∞–º–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ contents —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
      –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –≤–∏–¥—è—Ç —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –∑–∞—à–∏—Ç –≤ –∫–æ–¥–µ. –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.
    */
    const CONFIG = {
      owner: 'Anatoliy031',
      repo: 'Task',
      branch: 'main',
      path: 'tasks.json',
      token: '' // ‚Üê —Å—é–¥–∞ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à GitHub PAT (fine-grained)
    };
    // URL –¥–ª—è GitHub API
    function apiUrl(){
      return \`https://api.github.com/repos/\${encodeURIComponent(CONFIG.owner)}/\${encodeURIComponent(CONFIG.repo)}/contents/\${CONFIG.path}\`;
    }
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let state = {
      tasks: [],
      lastLoaded: null,
      remoteSha: null,
      saving: false,
      filter: 'all',
      search: '',
      me: localStorage.getItem('drnu_me_v2') || '',
      pendingSave: false
    };
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ vacations.json
    let employees = [];
    async function loadEmployees(){
      try {
        const resp = await fetch('vacations.json?v=' + Date.now(), { cache: 'no-store' });
        const vac = await resp.json();
        employees = (vac.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏||[]).map(x => x['–§–ò–û']).filter(Boolean).sort((a,b)=>a.localeCompare(b,'ru'));
      } catch(e) {
        employees = [];
      }
    }
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ tasks.json (–æ–±—ã—á–Ω—ã–π GET)
    async function loadTasks(){
      try {
        const resp = await fetch(\`\${CONFIG.path}?v=\${Date.now()}\`, { cache:'no-store' });
        if(!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å tasks.json');
        const file = await resp.json();
        const normalized = normalizeFile(file);
        state.tasks = normalized.–∑–∞–¥–∞—á–∏;
        state.lastLoaded = Date.now();
        renderAll();
      } catch(e) {
        console.error(e);
      }
    }
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á–∏
    function normalizeTask(t){
      return {
        id: String(t.id || '').trim() || genId(),
        –∑–∞–¥–∞—á–∞: String(t.–∑–∞–¥–∞—á–∞ || '').trim(),
        –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: String(t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || '').trim(),
        —Å—Ä–æ–∫: t.—Å—Ä–æ–∫ ? String(t.—Å—Ä–æ–∫).slice(0,10) : '',
        —Å—Ç–∞—Ç—É—Å: ['–í –ø–ª–∞–Ω','–í —Ä–∞–±–æ—Ç–µ','–ì–æ—Ç–æ–≤–æ'].includes(t.—Å—Ç–∞—Ç—É—Å) ? t.—Å—Ç–∞—Ç—É—Å : '–í —Ä–∞–±–æ—Ç–µ',
        —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥: String(t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ || '').trim(),
        _–∏–∑–º–µ–Ω–µ–Ω–æ: t._–∏–∑–º–µ–Ω–µ–Ω–æ || new Date().toISOString()
      };
    }
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞
    function normalizeFile(f){
      const out = { –≤–µ—Ä—Å–∏—è: 1, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: f.–æ–±–Ω–æ–≤–ª–µ–Ω–æ || new Date().toISOString(), –∑–∞–¥–∞—á–∏: [] };
      if(Array.isArray(f.–∑–∞–¥–∞—á–∏)){
        out.–∑–∞–¥–∞—á–∏ = f.–∑–∞–¥–∞—á–∏.map(normalizeTask);
      }
      out.–∑–∞–¥–∞—á–∏.sort(sortTasks);
      return out;
    }
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—ã + —Å–ª—É—á–∞–π–Ω–æ–≥–æ)
    function genId(){
      const d = new Date();
      const y = String(d.getFullYear());
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const rnd = Math.random().toString(36).substr(2,4).toUpperCase();
      return \`T-\${y}\${m}\${dd}-\${rnd}\`;
    }
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ä–æ–∫–æ–≤
    function isOverdue(task){
      if(task.—Å—Ç–∞—Ç—É—Å === '–ì–æ—Ç–æ–≤–æ') return false;
      if(!task.—Å—Ä–æ–∫) return false;
      const due = new Date(task.—Å—Ä–æ–∫ + 'T00:00:00');
      const today = new Date();
      today.setHours(0,0,0,0);
      return due < today;
    }
    function isSoon(task, days=3){
      if(task.—Å—Ç–∞—Ç—É—Å === '–ì–æ—Ç–æ–≤–æ') return false;
      if(!task.—Å—Ä–æ–∫) return false;
      const due = new Date(task.—Å—Ä–æ–∫ + 'T00:00:00');
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.floor((due - today) / 86400000);
      return diff >= 0 && diff <= days;
    }
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á: –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ, –≥–æ—Ä—è—â–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ; –ø–æ—Ç–æ–º –ø–æ –¥–∞—Ç–µ
    function sortTasks(a,b){
      const ao = isOverdue(a) ? 0 : (isSoon(a) ? 1 : 2);
      const bo = isOverdue(b) ? 0 : (isSoon(b) ? 1 : 2);
      if(ao !== bo) return ao - bo;
      const ad = a.—Å—Ä–æ–∫ ? new Date(a.—Å—Ä–æ–∫ + 'T00:00:00').getTime() : Infinity;
      const bd = b.—Å—Ä–æ–∫ ? new Date(b.—Å—Ä–æ–∫ + 'T00:00:00').getTime() : Infinity;
      if(ad !== bd) return ad - bd;
      return a.id.localeCompare(b.id);
    }
    // –ü–æ–¥—Å—á—ë—Ç KPI
    function getSummary(){
      const all = state.tasks;
      return {
        overdue: all.filter(t => isOverdue(t)).length,
        soon: all.filter(t => !isOverdue(t) && isSoon(t)).length,
        inProgress: all.filter(t => t.—Å—Ç–∞—Ç—É—Å === '–í —Ä–∞–±–æ—Ç–µ').length,
        plan: all.filter(t => t.—Å—Ç–∞—Ç—É—Å === '–í –ø–ª–∞–Ω').length,
        done: all.filter(t => t.—Å—Ç–∞—Ç—É—Å === '–ì–æ—Ç–æ–≤–æ').length
      };
    }
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á
    function filteredTasks(){
      let arr = state.tasks.slice();
      // quick filter
      switch(state.filter){
        case 'mine': if(state.me) arr = arr.filter(t => t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π === state.me); break;
        case 'overdue': arr = arr.filter(isOverdue); break;
        case 'soon': arr = arr.filter(t => !isOverdue(t) && isSoon(t)); break;
        case 'done': arr = arr.filter(t => t.—Å—Ç–∞—Ç—É—Å === '–ì–æ—Ç–æ–≤–æ'); break;
        default: break;
      }
      // search filter
      const q = (state.search || '').trim().toLowerCase();
      if(q){
        arr = arr.filter(t => \`\${t.id} \${t.–∑–∞–¥–∞—á–∞} \${t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π} \${t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥}\`.toLowerCase().includes(q));
      }
      arr.sort(sortTasks);
      return arr;
    }
    // –†–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function renderAll(){
      renderSummary();
      renderFilterChips();
      renderTasks();
      renderMeSelect();
    }
    function renderSummary(){
      const s = getSummary();
      const container = document.getElementById('summary');
      container.innerHTML = [
        \`<span class="chip"><span class="dot bad"></span>üî¥ \${s.overdue}</span>\`,
        \`<span class="chip"><span class="dot warn"></span>üü° \${s.soon}</span>\`,
        \`<span class="chip"><span class="dot"></span>üü¢ \${s.inProgress}</span>\`,
        \`<span class="chip"><span class="dot"></span>üìå \${s.plan}</span>\`,
        \`<span class="chip"><span class="dot good"></span>‚úÖ \${s.done}</span>\`
      ].join('');
      // status line: last updated, saving state
      const statusEl = document.getElementById('statusLine');
      const updatedText = state.lastLoaded ? \`–û–±–Ω–æ–≤–ª–µ–Ω–æ: \${new Date(state.lastLoaded).toLocaleTimeString('ru-RU')}\` : '';
      let savingText = '';
      if(state.saving) savingText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      else if(state.pendingSave) savingText = '–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
      statusEl.textContent = \`\${updatedText}\${updatedText && (savingText?' ‚Ä¢ ':'')}\${savingText}\`;
    }
    function renderFilterChips(){
      const chips = [
        { key:'all', label:'–í—Å–µ' },
        { key:'mine', label:'–ú–æ–∏' },
        { key:'overdue', label:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ' },
        { key:'soon', label:'‚â§3 –¥–Ω—è' },
        { key:'done', label:'–ì–æ—Ç–æ–≤–æ' }
      ];
      const el = document.getElementById('filterChips');
      el.innerHTML = chips.map(c => \`<div class="filter-chip \${c.key===state.filter?'active':''}" data-key="\${c.key}">\${c.label}</div>\`).join('');
      el.querySelectorAll('.filter-chip').forEach(btn => {
        btn.addEventListener('click', () => {
          state.filter = btn.getAttribute('data-key');
          renderTasks();
          renderFilterChips();
        });
      });
    }
    function renderMeSelect(){
      const select = document.getElementById('meSelect');
      select.innerHTML = ['<option value="">‚Äî</option>'].concat(
        employees.map(name => \`<option value="\${escapeHtml(name)}">\${escapeHtml(name)}</option>\`)
      ).join('');
      if(state.me && employees.includes(state.me)) select.value = state.me;
      select.addEventListener('change', () => {
        state.me = select.value || '';
        localStorage.setItem('drnu_me_v2', state.me);
        renderTasks();
      });
    }
    function renderTasks(){
      const list = document.getElementById('task-list');
      const tasks = filteredTasks();
      list.innerHTML = tasks.length ? tasks.map(t => renderTaskCard(t)).join('') : \`<div class="task-card"><div>–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</div></div>\`;
      // attach actions
      document.querySelectorAll('.task-actions button[data-id]').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if(action === 'edit') openModalEdit(id);
          else if(action === 'delete') deleteTask(id);
          else if(action === 'done') markDone(id);
        });
      });
      // attach click to open edit by clicking anywhere on card except actions
      document.querySelectorAll('.task-card[data-id]').forEach(card => {
        const id = card.getAttribute('data-id');
        card.addEventListener('click', (e) => {
          // ignore if clicked on button
          if(e.target.closest('button')) return;
          openModalEdit(id);
        });
      });
    }
    function renderTaskCard(t){
      const overdue = isOverdue(t);
      const soon = isSoon(t);
      let badgeClass = '';
      if(t.—Å—Ç–∞—Ç—É—Å === '–ì–æ—Ç–æ–≤–æ') badgeClass = 'good';
      else if(overdue) badgeClass = 'bad';
      else if(soon) badgeClass = 'warn';
      return \`<div class="task-card" data-id="\${escapeHtml(t.id)}">
        <div class="task-top">
          <span class="task-id">\${escapeHtml(t.id)}</span>
          <span class="due-badge \${badgeClass}">\${t.—Å—Ä–æ–∫ ? escapeHtml(t.—Å—Ä–æ–∫) : '‚Äî'}</span>
        </div>
        <div class="task-desc">\${escapeHtml(t.–∑–∞–¥–∞—á–∞)}</div>
        <div class="task-meta">
          \${t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π ? \`<span>üë§ \${escapeHtml(t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π)}</span>\` : ''}
          \${t.—Å—Ç–∞—Ç—É—Å ? \`<span>üìå \${escapeHtml(t.—Å—Ç–∞—Ç—É—Å)}</span>\` : ''}
          \${t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ ? \`<span>‚û°Ô∏è \${escapeHtml(t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥)}</span>\` : ''}
        </div>
        <div class="task-actions">
          \${t.—Å—Ç–∞—Ç—É—Å !== '–ì–æ—Ç–æ–≤–æ' ? \`<button data-id="\${escapeHtml(t.id)}" data-action="done" class="done" title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≥–æ—Ç–æ–≤–æ">‚úî</button>\` : ''}
          <button data-id="\${escapeHtml(t.id)}" data-action="edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button data-id="\${escapeHtml(t.id)}" data-action="delete" class="danger" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
        </div>
      </div>\`;
    }
    // Escape HTML helper
    function escapeHtml(str){
      return String(str).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[m]));
    }
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    function openModalNew(){
      document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
      document.getElementById('taskId').value = '';
      document.getElementById('taskText').value = '';
      document.getElementById('taskOwner').value = state.me || '';
      document.getElementById('taskDue').value = '';
      document.getElementById('taskStatus').value = '–í —Ä–∞–±–æ—Ç–µ';
      document.getElementById('taskNext').value = '';
      document.getElementById('modal').classList.add('open');
    }
    function openModalEdit(id){
      const t = state.tasks.find(x => x.id === id);
      if(!t) return;
      document.getElementById('modalTitle').textContent = \`–ó–∞–¥–∞—á–∞ \${escapeHtml(t.id)}\`;
      document.getElementById('taskId').value = t.id;
      document.getElementById('taskText').value = t.–∑–∞–¥–∞—á–∞;
      document.getElementById('taskOwner').value = t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || '';
      document.getElementById('taskDue').value = t.—Å—Ä–æ–∫ || '';
      document.getElementById('taskStatus').value = t.—Å—Ç–∞—Ç—É—Å;
      document.getElementById('taskNext').value = t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ || '';
      document.getElementById('modal').classList.add('open');
    }
    function closeModal(){
      document.getElementById('modal').classList.remove('open');
    }
    function saveTaskFromModal(){
      const id = document.getElementById('taskId').value;
      const text = document.getElementById('taskText').value.trim();
      if(!text){ alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É'); return; }
      const owner = document.getElementById('taskOwner').value || '';
      const due = document.getElementById('taskDue').value || '';
      const status = document.getElementById('taskStatus').value;
      const next = document.getElementById('taskNext').value.trim();
      if(id){
        // edit existing
        const idx = state.tasks.findIndex(x => x.id === id);
        if(idx >= 0){
          state.tasks[idx] = normalizeTask({ id, –∑–∞–¥–∞—á–∞:text, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:owner, —Å—Ä–æ–∫:due, —Å—Ç–∞—Ç—É—Å:status, —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥:next, _–∏–∑–º–µ–Ω–µ–Ω–æ: new Date().toISOString() });
        }
      } else {
        // new
        const t = normalizeTask({ id: genId(), –∑–∞–¥–∞—á–∞:text, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:owner, —Å—Ä–æ–∫:due, —Å—Ç–∞—Ç—É—Å:status, —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥:next, _–∏–∑–º–µ–Ω–µ–Ω–æ: new Date().toISOString() });
        state.tasks.push(t);
      }
      state.pendingSave = true;
      state.tasks.sort(sortTasks);
      renderAll();
      closeModal();
      scheduleSave();
    }
    function deleteTask(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
      state.tasks = state.tasks.filter(x => x.id !== id);
      state.pendingSave = true;
      renderAll();
      scheduleSave();
    }
    function markDone(id){
      const idx = state.tasks.findIndex(x => x.id === id);
      if(idx < 0) return;
      state.tasks[idx].—Å—Ç–∞—Ç—É—Å = '–ì–æ—Ç–æ–≤–æ';
      state.tasks[idx]._–∏–∑–º–µ–Ω–µ–Ω–æ = new Date().toISOString();
      state.pendingSave = true;
      renderAll();
      scheduleSave();
    }
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ GitHub
    let saveTimer = null;
    function scheduleSave(){
      if(saveTimer) clearTimeout(saveTimer);
      // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
      saveTimer = setTimeout(() => {
        saveTasksToGitHub().catch(console.error);
      }, 2000);
    }
    async function saveTasksToGitHub(){
      if(!CONFIG.token){
        console.warn('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
        state.pendingSave = false;
        renderSummary();
        return;
      }
      state.saving = true;
      state.pendingSave = false;
      renderSummary();
      try {
        // 1. –ü–æ–ª—É—á–∞–µ–º remote sha –∏ —Ñ–∞–π–ª –¥–ª—è —Å–ª–∏—è–Ω–∏—è
        const { sha: remoteSha, file: remoteFile } = await loadRemoteFileViaAPI();
        state.remoteSha = remoteSha;
        // 2. –°–ª–∏—è–Ω–∏–µ local + remote –ø–æ id / _–∏–∑–º–µ–Ω–µ–Ω–æ
        const localFile = normalizeFile({ –∑–∞–¥–∞—á–∏: state.tasks, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: new Date().toISOString() });
        const merged = mergeFiles(remoteFile, localFile);
        // 3. PUT –Ω–∞ GitHub API
        const body = {
          message: \`–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á \${new Date().toLocaleString('ru-RU')}\`,
          content: btoa(unescape(encodeURIComponent(JSON.stringify(merged, null, 2)))),
          branch: CONFIG.branch,
          sha: remoteSha
        };
        const r = await fetch(apiUrl(), {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + CONFIG.token,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if(!r.ok){
          const txt = await r.text();
          throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + r.status + ' ' + txt);
        }
        // —É—Å–ø–µ—à–Ω–æ
        state.tasks = merged.–∑–∞–¥–∞—á–∏;
        state.saving = false;
        state.pendingSave = false;
        state.lastLoaded = Date.now();
        renderAll();
      } catch(e) {
        console.error(e);
        // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ pendingSave true, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
        state.saving = false;
        state.pendingSave = true;
        renderSummary();
      }
    }
    // –ó–∞–≥—Ä—É–∑–∫–∞ remote —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ GitHub API (–ø–æ–ª—É—á–∞–µ–º sha + json)
    async function loadRemoteFileViaAPI(){
      const url = apiUrl() + '?ref=' + encodeURIComponent(CONFIG.branch);
      const r = await fetch(url, {
        headers: {
          'Authorization': CONFIG.token ? 'Bearer ' + CONFIG.token : undefined,
          'Accept': 'application/vnd.github+json'
        }
      });
      if(!r.ok){
        throw new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ GitHub API: ' + r.status);
      }
      const j = await r.json();
      const content = j.content ? atob(j.content.replace(/\\n/g,'')) : '{}';
      let file;
      try {
        file = JSON.parse(content);
      } catch(e){
        file = { –∑–∞–¥–∞—á–∏: [] };
      }
      return { sha: j.sha, file: normalizeFile(file) };
    }
    // –°–ª–∏—è–Ω–∏–µ —Ñ–∞–π–ª–æ–≤: –ø–æ id, –±–µ—Ä—ë–º —Ç—É, —É –∫–æ—Ç–æ—Ä–æ–π _–∏–∑–º–µ–Ω–µ–Ω–æ —Å–≤–µ–∂–∏–π
    function mergeFiles(remote, local){
      const map = new Map();
      // remote
      for(const t of remote.–∑–∞–¥–∞—á–∏) map.set(t.id, t);
      // local
      for(const t of local.–∑–∞–¥–∞—á–∏){
        const prev = map.get(t.id);
        if(!prev) map.set(t.id, t);
        else {
          const a = new Date(prev._–∏–∑–º–µ–Ω–µ–Ω–æ || '1970-01-01').getTime();
          const b = new Date(t._–∏–∑–º–µ–Ω–µ–Ω–æ || '1970-01-01').getTime();
          map.set(t.id, b >= a ? t : prev);
        }
      }
      const merged = { –≤–µ—Ä—Å–∏—è: 1, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: new Date().toISOString(), –∑–∞–¥–∞—á–∏: Array.from(map.values()) };
      merged.–∑–∞–¥–∞—á–∏.sort(sortTasks);
      return merged;
    }
    // Utils: periodic refresh
    function startAutoRefresh(){
      setInterval(async () => {
        if(state.saving || state.pendingSave) return;
        try {
          const resp = await fetch(\`\${CONFIG.path}?v=\${Date.now()}\`, { cache:'no-store' });
          if(resp.ok){
            const file = await resp.json();
            const norm = normalizeFile(file);
            // –ï—Å–ª–∏ remote –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ _–∏–∑–º–µ–Ω–µ–Ω–æ –∑–∞–¥–∞—á–∏? –õ—É—á—à–µ –ø–æ id count or hash; —É–ø—Ä–æ—â—ë–Ω–Ω–æ: –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
            if(norm.–∑–∞–¥–∞—á–∏.length !== state.tasks.length || JSON.stringify(norm.–∑–∞–¥–∞—á–∏.map(t=>t._–∏–∑–º–µ–Ω–µ–Ω–æ)) !== JSON.stringify(state.tasks.map(t=>t._–∏–∑–º–µ–Ω–µ–Ω–æ))){
              state.tasks = norm.–∑–∞–¥–∞—á–∏;
              state.lastLoaded = Date.now();
              renderAll();
            }
          }
        } catch(e){ console.error(e); }
      }, 30000);
    }
    // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    async function init(){
      await loadEmployees();
      renderMeSelect();
      // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≤ –º–æ–¥–∞–ª–µ
      const selAdd = document.getElementById('taskOwner');
      selAdd.innerHTML = ['<option value="">‚Äî</option>'].concat(employees.map(n=>\`<option value="\${escapeHtml(n)}">\${escapeHtml(n)}</option>\`)).join('');
      // –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è
      document.getElementById('searchInput').addEventListener('input', (e) => {
        state.search = e.target.value;
        renderTasks();
      });
      document.getElementById('add-task-btn').addEventListener('click', openModalNew);
      document.getElementById('cancelBtn').addEventListener('click', (e) => {
        e.preventDefault(); closeModal();
      });
      document.getElementById('taskForm').addEventListener('submit', (e) => {
        e.preventDefault(); saveTaskFromModal();
      });
      // load tasks
      await loadTasks();
      startAutoRefresh();
    }
    init();
  })();
  </script>
</body>
</html>
