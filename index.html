<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á ‚Äî –î–†–ù–£ (–ö—É–±–∞–Ω—å—ç–Ω–µ—Ä–≥–æ)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#101b31;
      --line:rgba(255,255,255,.10);
      --text:#eaf1ff;
      --muted:#a8b3c7;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --info:#60a5fa;
      --chip:rgba(255,255,255,.06);
      --shadow:0 18px 60px rgba(0,0,0,.35);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 18% 10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(1000px 700px at 85% 0%, rgba(52,211,153,.12), transparent 50%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .top{
      position:sticky; top:10px; z-index:30;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(16,27,49,.78);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
    }
    .title{display:flex;flex-direction:column;gap:4px}
    .title h1{margin:0;font-size:15px;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .statusDot{width:9px;height:9px;border-radius:50%;background:var(--warn);display:inline-block}
    .statusDot.ok{background:var(--good)}
    .statusDot.bad{background:var(--bad)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    button.primary{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.55)}
    button.good{background:rgba(52,211,153,.14);border-color:rgba(52,211,153,.45)}
    button.danger{background:rgba(251,113,133,.16);border-color:rgba(251,113,133,.45)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--info)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .top{position:static}
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:rgba(16,27,49,.70);
      backdrop-filter: blur(10px);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
    }
    .hd .h{font-size:13px;font-weight:800}
    .bd{padding:12px 14px}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, textarea{
      width:100%;
      background:rgba(10,18,36,.75);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    textarea{min-height:84px;resize:vertical}
    .two{display:grid;grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 640px){ .two{grid-template-columns:1fr} }

    .quick{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    .qbtn{
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
    }
    .qbtn.active{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.55);
    }

    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:920px;background:rgba(10,18,36,.55)}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.07);font-size:13px;vertical-align:top}
    th{position:sticky;top:0;background:rgba(10,18,36,.95);color:var(--muted);font-weight:700;text-align:left;z-index:2}
    tr:hover td{background:rgba(255,255,255,.03)}
    .mono{font-family:var(--mono);font-size:12px;color:#d7e3ff}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
      white-space:nowrap;
    }
    .badge.bad{border-color:rgba(251,113,133,.45);background:rgba(251,113,133,.12)}
    .badge.warn{border-color:rgba(251,191,36,.45);background:rgba(251,191,36,.10)}
    .badge.good{border-color:rgba(52,211,153,.45);background:rgba(52,211,153,.10)}

    .muted{color:var(--muted)}
    .small{font-size:12px}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal{
      position:fixed; inset:0; z-index:60;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:14px;
    }
    .modal.open{display:flex}
    .box{
      width:min(780px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(16,27,49,.92);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .box .hd{border-bottom:1px solid var(--line)}
    .box .bd{padding:14px}
    .rightBtns{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}

    .warnLine{
      margin-top:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(251,191,36,.45);
      background:rgba(251,191,36,.10);
      font-size:12px;
    }

    .vacBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(10,18,36,.45);
    }
    details summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      font-size:13px;
    }
    details summary::-webkit-details-marker{display:none}
    .vacList{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .vacItem{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      font-size:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      padding:7px 9px;
      border-radius:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>–¢—Ä–µ–∫–µ—Ä –∑–∞–¥–∞—á –î–†–ù–£</h1>
        <div class="sub">
          <span><span id="syncDot" class="statusDot"></span> <span id="syncText">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span></span>
          <span class="muted">‚Ä¢</span>
          <span class="muted">–æ–±—â–∏–π —Ñ–∞–π–ª: <span class="mono" id="filePathView">tasks.json</span></span>
        </div>
      </div>
      <div class="actions">
        <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button id="btnSave" class="good">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="btnSummary" class="primary">–°–≤–æ–¥–∫–∞ (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)</button>
        <button id="btnSettings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <div class="chips" id="kpi"></div>
      <div style="margin-left:auto" class="row">
        <label style="margin:0;display:flex;gap:8px;align-items:center" class="small">
          <span class="muted">–Ø:</span>
          <select id="meSel" style="width:auto;min-width:260px"></select>
        </label>
      </div>
    </div>

    <div class="grid">
      <!-- –õ–ï–í–û: —Ç–∞–±–ª–∏—Ü–∞ -->
      <div class="card">
        <div class="hd">
          <div class="h">–ó–∞–¥–∞—á–∏</div>
          <div class="quick" id="quickFilters"></div>
        </div>
        <div class="bd">
          <div class="two">
            <div>
              <label>–ü–æ–∏—Å–∫</label>
              <input id="q" placeholder="ID / –∑–∞–¥–∞—á–∞ / –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π / —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥" />
            </div>
            <div class="two" style="grid-template-columns: 1fr 1fr;">
              <div>
                <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                <select id="fOwner"></select>
              </div>
              <div>
                <label>–°—Ç–∞—Ç—É—Å</label>
                <select id="fStatus">
                  <option value="">–í—Å–µ</option>
                  <option value="–í –ø–ª–∞–Ω">–í –ø–ª–∞–Ω</option>
                  <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                  <option value="–ì–æ—Ç–æ–≤–æ">–ì–æ—Ç–æ–≤–æ</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-top:10px" class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">ID</th>
                  <th>–ó–∞–¥–∞—á–∞</th>
                  <th style="width:220px">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                  <th style="width:150px">–°—Ä–æ–∫</th>
                  <th style="width:120px">–°—Ç–∞—Ç—É—Å</th>
                  <th>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</th>
                </tr>
              </thead>
              <tbody id="tb"></tbody>
            </table>
          </div>

          <div class="hint" style="margin-top:10px">
            –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî üî¥, —Å—Ä–æ–∫ ‚â§ 3 –¥–Ω–µ–π ‚Äî üü°.
          </div>
        </div>
      </div>

      <!-- –ü–†–ê–í–û: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ + –æ—Ç–ø—É—Å–∫–∞ -->
      <div class="card">
        <div class="hd">
          <div class="h">–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å</div>
          <div class="rightBtns">
            <button id="btnNew" class="primary">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
          </div>
        </div>
        <div class="bd">
          <div>
            <label>–ó–∞–¥–∞—á–∞</label>
            <textarea id="nTask" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ: —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å?"></textarea>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <select id="nOwner"></select>
            </div>
            <div>
              <label>–°—Ä–æ–∫</label>
              <input id="nDue" type="date" />
            </div>
          </div>

          <div class="two" style="margin-top:10px">
            <div>
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select id="nStatus">
                <option>–í –ø–ª–∞–Ω</option>
                <option selected>–í —Ä–∞–±–æ—Ç–µ</option>
                <option>–ì–æ—Ç–æ–≤–æ</option>
              </select>
            </div>
            <div>
              <label>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</label>
              <input id="nNext" placeholder="–û–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ: —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å / –æ—Ç–ø—Ä–∞–≤–∏—Ç—å / –ø–æ–∑–≤–æ–Ω–∏—Ç—å..." />
            </div>
          </div>

          <div id="nWarn" class="warnLine" style="display:none"></div>

          <div class="row" style="margin-top:10px">
            <button id="btnAdd" class="good">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="btnClearNew">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div style="margin-top:14px" class="vacBox">
            <details>
              <summary>–û—Ç–ø—É—Å–∫–∞ (–∫–æ–Ω—Ç—Ä–æ–ª—å)</summary>
              <div class="muted small" style="margin-top:6px">
                –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –∏–∑ <span class="mono">vacations.json</span>. –ü–æ–ª–µ–∑–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∏ –Ω–∞ –ª—é–¥–µ–π –≤ –æ—Ç–ø—É—Å–∫–µ.
              </div>
              <div class="vacList" id="vacToday"></div>
              <div class="vacList" id="vacSoon" style="margin-top:8px"></div>
            </details>
          </div>

          <div class="hint" style="margin-top:12px">
            ‚Äú–ü–æ-–≤–∑—Ä–æ—Å–ª–æ–º—É‚Äù: –æ–±—â–∏–π —Ñ–∞–π–ª <span class="mono">tasks.json</span> –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
            –ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è ‚Äî –Ω—É–∂–µ–Ω GitHub —Ç–æ–∫–µ–Ω —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–≤–≤–æ–¥–∏—Ç—Å—è –≤ ‚Äú–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö‚Äù –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —É –Ω–µ–≥–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
  <div id="mEdit" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <div class="hd">
        <div class="h">–ó–∞–¥–∞—á–∞ <span class="mono" id="mId"></span></div>
        <div class="rightBtns">
          <button id="mClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div class="bd">
        <div>
          <label>–ó–∞–¥–∞—á–∞</label>
          <textarea id="mTask"></textarea>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
            <select id="mOwner"></select>
          </div>
          <div>
            <label>–°—Ä–æ–∫</label>
            <input id="mDue" type="date" />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select id="mStatus">
              <option>–í –ø–ª–∞–Ω</option>
              <option>–í —Ä–∞–±–æ—Ç–µ</option>
              <option>–ì–æ—Ç–æ–≤–æ</option>
            </select>
          </div>
          <div>
            <label>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</label>
            <input id="mNext" />
          </div>
        </div>

        <div id="mWarn" class="warnLine" style="display:none"></div>

        <div class="row" style="margin-top:12px">
          <button id="mSave" class="good">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="mDone" class="primary">–û—Ç–º–µ—Ç–∏—Ç—å ‚Äú–ì–æ—Ç–æ–≤–æ‚Äù</button>
          <button id="mDel" class="danger">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–û–î–ê–õ–ö–ê: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div id="mSet" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <div class="hd">
        <div class="h">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</div>
        <div class="rightBtns">
          <button id="sClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div class="bd">
        <div class="two">
          <div>
            <label>–í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (owner)</label>
            <input id="sOwner" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: Anatoliy031" />
          </div>
          <div>
            <label>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (repo)</label>
            <input id="sRepo" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: drnu-task-tracker" />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>–í–µ—Ç–∫–∞</label>
            <input id="sBranch" placeholder="main" />
          </div>
          <div>
            <label>–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∑–∞–¥–∞—á</label>
            <input id="sPath" placeholder="tasks.json" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>GitHub —Ç–æ–∫–µ–Ω (PAT) ‚Äî –Ω—É–∂–µ–Ω –¥–ª—è ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù</label>
          <input id="sToken" placeholder="ghp_... (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ)" />
          <div class="hint" style="margin-top:6px">
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –¥–µ–ª–∞–π—Ç–µ —Ç–æ–∫–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ <b>Contents: Read and write</b> —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (fine-grained token).
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="sSave" class="good">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
          <button id="sTest">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>

        <div id="sMsg" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

<script>
/* ==========================
   –ö–æ–Ω—Ñ–∏–≥ / —Å–æ—Å—Ç–æ—è–Ω–∏–µ
========================== */
const LS_CFG = "drnu_cfg_v2";
const LS_ME  = "drnu_me_v2";

const DEFAULT_CFG = { owner:"", repo:"", branch:"main", path:"tasks.json", token:"" };

let CFG = loadCfg();
let VAC = { —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: [] };

let STATE = {
  tasks: [],
  remoteSha: null,
  lastLoadedAt: null,
  quick: "–í—Å–µ", // –í—Å–µ | –ú–æ–∏ | –ì–æ—Ä–∏—Ç | –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ | –ì–æ—Ç–æ–≤–æ
};

const $ = (id)=>document.getElementById(id);

function loadCfg(){
  try { return { ...DEFAULT_CFG, ...(JSON.parse(localStorage.getItem(LS_CFG)||"{}")) }; }
  catch { return { ...DEFAULT_CFG }; }
}
function saveCfg(){
  localStorage.setItem(LS_CFG, JSON.stringify(CFG));
  $("filePathView").textContent = CFG.path || "tasks.json";
  updateSyncUI();
}

function isoNow(){ return new Date().toISOString(); }
function todayISO(){
  const d=new Date(); const pad=(n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function addDaysISO(iso, n){
  const d = new Date(iso+"T00:00:00");
  d.setDate(d.getDate()+n);
  return d.toISOString().slice(0,10);
}
function escapeHTML(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({
  "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
}[m]));}

/* ==========================
   –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—É—Å–∫–æ–≤
========================== */
async function loadVacations(){
  try{
    const r = await fetch(`vacations.json?v=${Date.now()}`, { cache:"no-store" });
    if(!r.ok) throw new Error("vacations.json –Ω–µ –Ω–∞–π–¥–µ–Ω");
    VAC = await r.json();
  }catch(e){
    VAC = { —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: [] };
  }
}

function employees(){
  return (VAC.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ || []).map(x=>x["–§–ò–û"]).filter(Boolean).sort((a,b)=>a.localeCompare(b,"ru"));
}
function employeePosition(name){
  const e = (VAC.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏||[]).find(x=>x["–§–ò–û"]===name);
  return e ? (e["–¥–æ–ª–∂–Ω–æ—Å—Ç—å"]||"") : "";
}
function vacationsFor(name){
  const e = (VAC.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏||[]).find(x=>x["–§–ò–û"]===name);
  return e ? (e["–æ—Ç–ø—É—Å–∫–∞"]||[]) : [];
}
function dateInRange(dateISO, aISO, bISO){
  if(!dateISO || !aISO || !bISO) return false;
  const d=new Date(dateISO+"T00:00:00");
  const a=new Date(aISO+"T00:00:00");
  const b=new Date(bISO+"T00:00:00");
  return d>=a && d<=b;
}
function overlapsVacation(name, dateISO){
  const v = vacationsFor(name);
  for(const it of v){
    if(dateInRange(dateISO, it["–Ω–∞—á–∞–ª–æ"], it["–∫–æ–Ω–µ—Ü"])) return it;
  }
  return null;
}
function renderVacControl(){
  const t = todayISO();
  const soonTo = addDaysISO(t, 14);

  const todayList = [];
  const soonList = [];

  for(const e of (VAC.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏||[])){
    const fio = e["–§–ò–û"];
    const pos = e["–¥–æ–ª–∂–Ω–æ—Å—Ç—å"] || "";
    for(const v of (e["–æ—Ç–ø—É—Å–∫–∞"]||[])){
      const a=v["–Ω–∞—á–∞–ª–æ"], b=v["–∫–æ–Ω–µ—Ü"];
      if(dateInRange(t, a, b)){
        todayList.push({fio,pos,a,b,days:v["–¥–Ω–µ–π"]});
      }else{
        // –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π: –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ [t; soonTo]
        const A=new Date(a+"T00:00:00"), B=new Date(b+"T00:00:00");
        const T=new Date(t+"T00:00:00"), S=new Date(soonTo+"T00:00:00");
        if(B>=T && A<=S){
          soonList.push({fio,pos,a,b,days:v["–¥–Ω–µ–π"]});
        }
      }
    }
  }

  todayList.sort((x,y)=>x.fio.localeCompare(y.fio,"ru"));
  soonList.sort((x,y)=>new Date(x.a)-new Date(y.a));

  $("vacToday").innerHTML = todayList.length
    ? `<div class="muted small">–°–µ–≥–æ–¥–Ω—è –≤ –æ—Ç–ø—É—Å–∫–µ:</div>` + todayList.map(x =>
      `<div class="vacItem"><span class="dot warn"></span><b>${escapeHTML(x.fio)}</b><span class="muted">${escapeHTML(x.pos)}</span><span class="muted">‚Ä¢</span><span>${x.a} ‚Üí ${x.b}</span></div>`
    ).join("")
    : `<div class="muted small">–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ –≤ –æ—Ç–ø—É—Å–∫–µ (–ø–æ –¥–∞–Ω–Ω—ã–º –≥—Ä–∞—Ñ–∏–∫–∞).</div>`;

  $("vacSoon").innerHTML = soonList.length
    ? `<div class="muted small">–í –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π:</div>` + soonList.slice(0,8).map(x =>
      `<div class="vacItem"><span class="dot"></span><b>${escapeHTML(x.fio)}</b><span class="muted">${escapeHTML(x.pos)}</span><span class="muted">‚Ä¢</span><span>${x.a} ‚Üí ${x.b}</span></div>`
    ).join("") + (soonList.length>8 ? `<div class="muted small">‚Ä¶–∏ –µ—â—ë ${soonList.length-8}</div>` : "")
    : `<div class="muted small">–í –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π –æ—Ç–ø—É—Å–∫–æ–≤ –Ω–µ –≤–∏–¥–Ω–æ.</div>`;
}

/* ==========================
   GitHub —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
========================== */
function hasSyncConfig(){
  return !!(CFG.owner && CFG.repo && CFG.branch && CFG.path);
}
function hasToken(){
  return !!(CFG.token && CFG.token.trim().length > 10);
}
function updateSyncUI(){
  const dot = $("syncDot");
  const text = $("syncText");

  if(!hasSyncConfig()){
    dot.className="statusDot";
    text.textContent="–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è";
    $("btnSave").disabled = true;
    return;
  }
  if(!hasToken()){
    dot.className="statusDot";
    text.textContent="—Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)";
    $("btnSave").disabled = true;
    return;
  }
  dot.className="statusDot ok";
  text.textContent="–≥–æ—Ç–æ–≤–æ –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é –≤ GitHub";
  $("btnSave").disabled = false;
}

function ghApiUrl(){
  return `https://api.github.com/repos/${encodeURIComponent(CFG.owner)}/${encodeURIComponent(CFG.repo)}/contents/${CFG.path}?ref=${encodeURIComponent(CFG.branch)}`;
}
function ghHeaders(){
  return {
    "Accept":"application/vnd.github+json",
    "Authorization":`Bearer ${CFG.token}`,
    "X-GitHub-Api-Version":"2022-11-28"
  };
}
function b64utf8(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function utf8fromb64(b64){
  return decodeURIComponent(escape(atob(b64)));
}

async function loadTasksFromPages(){
  // –æ–±—â–∏–π –ø—Ä–æ—Å–º–æ—Ç—Ä: –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º tasks.json —Ä—è–¥–æ–º —Å index.html
  const path = CFG.path || "tasks.json";
  const r = await fetch(`${path}?v=${Date.now()}`, { cache:"no-store" });
  if(!r.ok) throw new Error(`–ù–µ –º–æ–≥—É –∑–∞–≥—Ä—É–∑–∏—Ç—å ${path}`);
  const j = await r.json();
  return normalizeFile(j);
}

async function loadRemoteSha(){
  // –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω—É–∂–µ–Ω sha —á–µ—Ä–µ–∑ API
  const r = await fetch(ghApiUrl(), { headers: ghHeaders() });
  if(!r.ok){
    const t = await r.text();
    throw new Error(`GitHub API (GET) –æ—à–∏–±–∫–∞: ${r.status}. ${t}`);
  }
  const j = await r.json();
  const content = j.content ? utf8fromb64(j.content.replace(/\n/g,"")) : null;
  const file = content ? normalizeFile(JSON.parse(content)) : normalizeFile({});
  return { sha: j.sha, file };
}

async function saveToGitHub(localFile){
  const { sha, file: remoteFile } = await loadRemoteSha();

  // –ú—è–≥–∫–æ–µ —Å–ª–∏—è–Ω–∏–µ: –ø–æ id, –±–µ—Ä—ë–º –±–æ–ª–µ–µ –Ω–æ–≤–æ–µ –ø–æ _–∏–∑–º–µ–Ω–µ–Ω–æ
  const merged = mergeFiles(remoteFile, localFile);

  const body = {
    message: `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á (${new Date().toLocaleString("ru-RU")})`,
    content: b64utf8(JSON.stringify(merged, null, 2)),
    sha,
    branch: CFG.branch
  };

  const r = await fetch(
    `https://api.github.com/repos/${encodeURIComponent(CFG.owner)}/${encodeURIComponent(CFG.repo)}/contents/${CFG.path}`,
    { method:"PUT", headers: { ...ghHeaders(), "Content-Type":"application/json" }, body: JSON.stringify(body) }
  );

  if(!r.ok){
    const t = await r.text();
    throw new Error(`GitHub API (PUT) –æ—à–∏–±–∫–∞: ${r.status}. ${t}`);
  }
  return true;
}

/* ==========================
   –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ / –∑–∞–¥–∞—á–∏
========================== */
function normalizeTask(t){
  const o = {
    id: String(t.id || "").trim(),
    –∑–∞–¥–∞—á–∞: String(t["–∑–∞–¥–∞—á–∞"] ?? "").trim(),
    –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: String(t["–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π"] ?? "").trim(),
    —Å—Ä–æ–∫: t["—Å—Ä–æ–∫"] ? String(t["—Å—Ä–æ–∫"]).slice(0,10) : "",
    —Å—Ç–∞—Ç—É—Å: (t["—Å—Ç–∞—Ç—É—Å"] || "–í —Ä–∞–±–æ—Ç–µ"),
    —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥: String(t["—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥"] ?? "").trim(),
    _–∏–∑–º–µ–Ω–µ–Ω–æ: t["_–∏–∑–º–µ–Ω–µ–Ω–æ"] || isoNow()
  };
  if(!o.id) o.id = genId();
  if(!["–í –ø–ª–∞–Ω","–í —Ä–∞–±–æ—Ç–µ","–ì–æ—Ç–æ–≤–æ"].includes(o.—Å—Ç–∞—Ç—É—Å)) o.—Å—Ç–∞—Ç—É—Å = "–í —Ä–∞–±–æ—Ç–µ";
  return o;
}
function normalizeFile(j){
  const f = {
    –≤–µ—Ä—Å–∏—è: 1,
    –æ–±–Ω–æ–≤–ª–µ–Ω–æ: j.–æ–±–Ω–æ–≤–ª–µ–Ω–æ || isoNow(),
    –∑–∞–¥–∞—á–∏: Array.isArray(j.–∑–∞–¥–∞—á–∏) ? j.–∑–∞–¥–∞—á–∏.map(normalizeTask) : []
  };
  return f;
}
function mergeFiles(remote, local){
  const r = normalizeFile(remote);
  const l = normalizeFile(local);

  const map = new Map();
  for(const t of r.–∑–∞–¥–∞—á–∏) map.set(t.id, t);

  for(const t of l.–∑–∞–¥–∞—á–∏){
    const prev = map.get(t.id);
    if(!prev){
      map.set(t.id, t);
    }else{
      const a = new Date(prev._–∏–∑–º–µ–Ω–µ–Ω–æ || "1970-01-01").getTime();
      const b = new Date(t._–∏–∑–º–µ–Ω–µ–Ω–æ || "1970-01-01").getTime();
      map.set(t.id, b >= a ? t : prev);
    }
  }

  const merged = {
    –≤–µ—Ä—Å–∏—è: 1,
    –æ–±–Ω–æ–≤–ª–µ–Ω–æ: isoNow(),
    –∑–∞–¥–∞—á–∏: Array.from(map.values())
  };
  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ/–≥–æ—Ä–∏—Ç, –ø–æ—Ç–æ–º –ø–æ —Å—Ä–æ–∫—É
  merged.–∑–∞–¥–∞—á–∏.sort(sortTasks);
  return merged;
}

function genId(){
  // —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–æ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
  const d = todayISO().replaceAll("-","");
  const rnd = Math.random().toString(16).slice(2,6).toUpperCase();
  return `T-${d}-${rnd}`;
}

/* ==========================
   –õ–æ–≥–∏–∫–∞ —Å—Ä–æ–∫–æ–≤ / —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
========================== */
function isOverdue(t){
  if(t.—Å—Ç–∞—Ç—É—Å==="–ì–æ—Ç–æ–≤–æ") return false;
  if(!t.—Å—Ä–æ–∫) return false;
  return new Date(t.—Å—Ä–æ–∫+"T00:00:00") < new Date(todayISO()+"T00:00:00");
}
function isSoon(t, days=3){
  if(t.—Å—Ç–∞—Ç—É—Å==="–ì–æ—Ç–æ–≤–æ") return false;
  if(!t.—Å—Ä–æ–∫) return false;
  const a = new Date(todayISO()+"T00:00:00");
  const b = new Date(t.—Å—Ä–æ–∫+"T00:00:00");
  const diff = Math.floor((b-a)/86400000);
  return diff>=0 && diff<=days;
}
function dueBadge(t){
  if(t.—Å—Ç–∞—Ç—É—Å==="–ì–æ—Ç–æ–≤–æ") return `<span class="badge good"><span class="dot good"></span>${t.—Å—Ä–æ–∫ || "‚Äî"}</span>`;
  if(isOverdue(t)) return `<span class="badge bad"><span class="dot bad"></span>${t.—Å—Ä–æ–∫ || "‚Äî"}</span>`;
  if(isSoon(t,3)) return `<span class="badge warn"><span class="dot warn"></span>${t.—Å—Ä–æ–∫ || "‚Äî"}</span>`;
  return `<span class="badge"><span class="dot"></span>${t.—Å—Ä–æ–∫ || "‚Äî"}</span>`;
}
function sortTasks(a,b){
  const ao = isOverdue(a)?0 : (isSoon(a)?1:2);
  const bo = isOverdue(b)?0 : (isSoon(b)?1:2);
  if(ao!==bo) return ao-bo;
  const ad = a.—Å—Ä–æ–∫ ? new Date(a.—Å—Ä–æ–∫+"T00:00:00").getTime() : 9e15;
  const bd = b.—Å—Ä–æ–∫ ? new Date(b.—Å—Ä–æ–∫+"T00:00:00").getTime() : 9e15;
  if(ad!==bd) return ad-bd;
  return a.id.localeCompare(b.id);
}

/* ==========================
   UI: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ / —Ñ–∏–ª—å—Ç—Ä—ã
========================== */
function renderEmployeeSelects(){
  const list = employees();
  const optsAll = [`<option value="">–í—Å–µ</option>`].concat(list.map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`)).join("");
  const opts = list.map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`).join("");

  $("fOwner").innerHTML = optsAll;
  $("nOwner").innerHTML = opts;
  $("mOwner").innerHTML = opts;

  // "–Ø"
  const meOpts = [`<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>`].concat(list.map(n=>`<option value="${escapeHTML(n)}">${escapeHTML(n)}</option>`)).join("");
  $("meSel").innerHTML = meOpts;

  const savedMe = localStorage.getItem(LS_ME) || "";
  if(savedMe && list.includes(savedMe)) $("meSel").value = savedMe;
}

function setQuick(name){
  STATE.quick = name;
  renderQuick();
  renderTable();
}
function renderQuick(){
  const items = ["–í—Å–µ","–ú–æ–∏","–ì–æ—Ä–∏—Ç","–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ","–ì–æ—Ç–æ–≤–æ"];
  $("quickFilters").innerHTML = items.map(x =>
    `<button class="qbtn ${x===STATE.quick?"active":""}" data-q="${escapeHTML(x)}">${escapeHTML(x)}</button>`
  ).join("");
  for(const b of $("quickFilters").querySelectorAll("button[data-q]")){
    b.addEventListener("click", ()=>setQuick(b.getAttribute("data-q")));
  }
}

function filteredTasks(){
  const q = ($("q").value||"").trim().toLowerCase();
  const owner = $("fOwner").value || "";
  const status = $("fStatus").value || "";
  const me = $("meSel").value || "";

  let arr = (STATE.tasks||[]).slice();

  // quick
  if(STATE.quick==="–ú–æ–∏" && me) arr = arr.filter(t=>t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π===me);
  if(STATE.quick==="–ì–æ—Ä–∏—Ç") arr = arr.filter(t=>isOverdue(t) || isSoon(t,3));
  if(STATE.quick==="–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ") arr = arr.filter(t=>isOverdue(t));
  if(STATE.quick==="–ì–æ—Ç–æ–≤–æ") arr = arr.filter(t=>t.—Å—Ç–∞—Ç—É—Å==="–ì–æ—Ç–æ–≤–æ");

  if(owner) arr = arr.filter(t=>t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π===owner);
  if(status) arr = arr.filter(t=>t.—Å—Ç–∞—Ç—É—Å===status);

  if(q){
    arr = arr.filter(t => (`${t.id} ${t.–∑–∞–¥–∞—á–∞} ${t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π} ${t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥}`.toLowerCase().includes(q)));
  }

  arr.sort(sortTasks);
  return arr;
}

function renderKPI(){
  const all = STATE.tasks || [];
  const overdue = all.filter(t=>isOverdue(t)).length;
  const soon = all.filter(t=>!isOverdue(t) && isSoon(t,3)).length;
  const inwork = all.filter(t=>t.—Å—Ç–∞—Ç—É—Å==="–í —Ä–∞–±–æ—Ç–µ").length;
  const plan = all.filter(t=>t.—Å—Ç–∞—Ç—É—Å==="–í –ø–ª–∞–Ω").length;
  const done = all.filter(t=>t.—Å—Ç–∞—Ç—É—Å==="–ì–æ—Ç–æ–≤–æ").length;

  $("kpi").innerHTML = [
    `<span class="chip"><span class="dot bad"></span>üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: <b>${overdue}</b></span>`,
    `<span class="chip"><span class="dot warn"></span>üü° ‚â§ 3 –¥–Ω—è: <b>${soon}</b></span>`,
    `<span class="chip"><span class="dot"></span>üü¢ –í —Ä–∞–±–æ—Ç–µ: <b>${inwork}</b></span>`,
    `<span class="chip"><span class="dot"></span>üìå –í –ø–ª–∞–Ω: <b>${plan}</b></span>`,
    `<span class="chip"><span class="dot good"></span>‚úÖ –ì–æ—Ç–æ–≤–æ: <b>${done}</b></span>`
  ].join("");
}

function renderTable(){
  renderKPI();
  const arr = filteredTasks();
  $("tb").innerHTML = arr.length ? arr.map(t=>{
    const vac = (t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π && t.—Å—Ä–æ–∫) ? overlapsVacation(t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π, t.—Å—Ä–æ–∫) : null;
    const vacMark = vac ? ` <span class="muted" title="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –≤ –æ—Ç–ø—É—Å–∫–µ –Ω–∞ –¥–∞—Ç—É —Å—Ä–æ–∫–∞">üèñÔ∏è</span>` : "";
    return `
      <tr data-id="${escapeHTML(t.id)}">
        <td class="mono">${escapeHTML(t.id)}</td>
        <td>${escapeHTML(t.–∑–∞–¥–∞—á–∞)}</td>
        <td>${escapeHTML(t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || "‚Äî")}${vacMark}</td>
        <td>${dueBadge(t)}</td>
        <td>${escapeHTML(t.—Å—Ç–∞—Ç—É—Å)}</td>
        <td>${escapeHTML(t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ || "")}</td>
      </tr>
    `;
  }).join("") : `<tr><td colspan="6" class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</td></tr>`;

  for(const tr of $("tb").querySelectorAll("tr[data-id]")){
    tr.addEventListener("click", ()=>openEdit(tr.getAttribute("data-id")));
  }
}

/* ==========================
   –î–æ–±–∞–≤–ª–µ–Ω–∏–µ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
========================== */
function warnFor(owner, dueISO, el){
  if(!owner || !dueISO){ el.style.display="none"; el.textContent=""; return; }
  const v = overlapsVacation(owner, dueISO);
  if(!v){ el.style.display="none"; el.textContent=""; return; }
  el.style.display="block";
  el.textContent = `‚ö†Ô∏è ${owner} –≤ –æ—Ç–ø—É—Å–∫–µ ${v["–Ω–∞—á–∞–ª–æ"]} ‚Üí ${v["–∫–æ–Ω–µ—Ü"]}. –ü–æ–¥—É–º–∞–π—Ç–µ –æ —Å—Ä–æ–∫–µ/–∑–∞–º–µ–Ω–µ.`;
}

function addTask(){
  const task = ($("nTask").value||"").trim();
  const owner = $("nOwner").value || "";
  const due = $("nDue").value || "";
  const status = $("nStatus").value || "–í —Ä–∞–±–æ—Ç–µ";
  const next = ($("nNext").value||"").trim();

  if(!task){ alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ ¬´–ó–∞–¥–∞—á–∞¬ª."); return; }

  const t = normalizeTask({
    id: genId(),
    –∑–∞–¥–∞—á–∞: task,
    –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: owner,
    —Å—Ä–æ–∫: due,
    —Å—Ç–∞—Ç—É—Å: status,
    —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥: next,
    _–∏–∑–º–µ–Ω–µ–Ω–æ: isoNow()
  });

  STATE.tasks.push(t);
  STATE.tasks.sort(sortTasks);

  // –æ—á–∏—Å—Ç–∫–∞
  $("nTask").value = "";
  $("nNext").value = "";
  $("nStatus").value = "–í —Ä–∞–±–æ—Ç–µ";
  $("nWarn").style.display="none";

  renderTable();
}

let EDIT_ID = null;

function openEdit(id){
  const t = (STATE.tasks||[]).find(x=>x.id===id);
  if(!t) return;

  EDIT_ID = id;
  $("mId").textContent = id;
  $("mTask").value = t.–∑–∞–¥–∞—á–∞ || "";
  $("mOwner").value = t.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || "";
  $("mDue").value = t.—Å—Ä–æ–∫ || "";
  $("mStatus").value = t.—Å—Ç–∞—Ç—É—Å || "–í —Ä–∞–±–æ—Ç–µ";
  $("mNext").value = t.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ || "";

  warnFor($("mOwner").value, $("mDue").value, $("mWarn"));
  $("mEdit").classList.add("open");
}
function closeEdit(){
  $("mEdit").classList.remove("open");
  EDIT_ID = null;
}
function saveEdit(){
  if(!EDIT_ID) return;
  const idx = STATE.tasks.findIndex(x=>x.id===EDIT_ID);
  if(idx<0) return;

  const task = ($("mTask").value||"").trim();
  if(!task){ alert("–ó–∞–¥–∞—á–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π."); return; }

  STATE.tasks[idx] = normalizeTask({
    id: EDIT_ID,
    –∑–∞–¥–∞—á–∞: task,
    –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: $("mOwner").value || "",
    —Å—Ä–æ–∫: $("mDue").value || "",
    —Å—Ç–∞—Ç—É—Å: $("mStatus").value || "–í —Ä–∞–±–æ—Ç–µ",
    —Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥: ($("mNext").value||"").trim(),
    _–∏–∑–º–µ–Ω–µ–Ω–æ: isoNow()
  });

  STATE.tasks.sort(sortTasks);
  closeEdit();
  renderTable();
}
function doneEdit(){
  $("mStatus").value="–ì–æ—Ç–æ–≤–æ";
  saveEdit();
}
function deleteEdit(){
  if(!EDIT_ID) return;
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É ${EDIT_ID}?`)) return;
  STATE.tasks = STATE.tasks.filter(x=>x.id!==EDIT_ID);
  closeEdit();
  renderTable();
}

/* ==========================
   –°–≤–æ–¥–∫–∞
========================== */
async function copySummary(){
  const all = (STATE.tasks||[]).slice().sort(sortTasks);
  const t = todayISO();

  const overdue = all.filter(x=>isOverdue(x));
  const soon = all.filter(x=>!isOverdue(x) && isSoon(x,3));
  const inwork = all.filter(x=>x.—Å—Ç–∞—Ç—É—Å==="–í —Ä–∞–±–æ—Ç–µ");

  const todayVac = [];
  for(const e of (VAC.—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏||[])){
    for(const v of (e.–æ—Ç–ø—É—Å–∫–∞||[])){
      if(dateInRange(t, v.–Ω–∞—á–∞–ª–æ, v.–∫–æ–Ω–µ—Ü)) todayVac.push(`${e["–§–ò–û"]} (${v.–Ω–∞—á–∞–ª–æ}‚Üí${v.–∫–æ–Ω–µ—Ü})`);
    }
  }

  function lines(arr){
    return arr.map(x=>`- ${x.id} ‚Äî ${x.–∑–∞–¥–∞—á–∞} / ${x.–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π || "‚Äî"} / —Å—Ä–æ–∫ ${x.—Å—Ä–æ–∫ || "‚Äî"} / —à–∞–≥: ${x.—Å–ª–µ–¥—É—é—â–∏–π_—à–∞–≥ || "‚Äî"}`).join("\n");
  }

  const text =
`–°–≤–æ–¥–∫–∞ –î–†–ù–£ –Ω–∞ ${new Date().toLocaleDateString("ru-RU")}

üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${overdue.length})
${overdue.length?lines(overdue):"- –Ω–µ—Ç"}

üü° –ì–æ—Ä–∏—Ç (‚â§3 –¥–Ω—è) (${soon.length})
${soon.length?lines(soon):"- –Ω–µ—Ç"}

üü¢ –í —Ä–∞–±–æ—Ç–µ (${inwork.length})
${inwork.length?lines(inwork.slice(0,20)):( "- –Ω–µ—Ç")}${inwork.length>20?`\n‚Ä¶–∏ –µ—â—ë ${inwork.length-20}`:""}

üèñÔ∏è –°–µ–≥–æ–¥–Ω—è –≤ –æ—Ç–ø—É—Å–∫–µ
${todayVac.length?todayVac.map(x=>`- ${x}`).join("\n"):"- –Ω–µ—Ç (–ø–æ –¥–∞–Ω–Ω—ã–º –≥—Ä–∞—Ñ–∏–∫–∞)"}
`;

  try{
    await navigator.clipboard.writeText(text);
    alert("–°–≤–æ–¥–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.");
  }catch{
    prompt("–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–≤–æ–¥–∫—É –≤—Ä—É—á–Ω—É—é:", text);
  }
}

/* ==========================
   –ó–∞–≥—Ä—É–∑–∫–∞ / —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
========================== */
async function loadAll(){
  try{
    // —á–∏—Ç–∞–µ–º –æ–±—â–∏–π tasks.json (—á–µ—Ä–µ–∑ Pages)
    const file = await loadTasksFromPages();
    STATE.tasks = (file.–∑–∞–¥–∞—á–∏||[]).map(normalizeTask).sort(sortTasks);
    STATE.lastLoadedAt = isoNow();

    renderTable();
    updateSyncUI();
  }catch(e){
    alert(String(e.message || e));
  }
}

async function saveAll(){
  if(!hasSyncConfig() || !hasToken()){
    alert("–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ owner/repo/branch/path –∏ —Ç–æ–∫–µ–Ω –≤ ¬´–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö¬ª.");
    return;
  }
  try{
    const localFile = normalizeFile({ –∑–∞–¥–∞—á–∏: STATE.tasks, –æ–±–Ω–æ–≤–ª–µ–Ω–æ: isoNow() });
    await saveToGitHub(localFile);
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub ‚úÖ\n–ï—Å–ª–∏ —É –∫–æ–≥–æ-—Ç–æ –æ—Ç–∫—Ä—ã—Ç–∞ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª.");
  }catch(e){
    alert(String(e.message || e));
  }
}

/* ==========================
   –ù–∞—Å—Ç—Ä–æ–π–∫–∏
========================== */
function openSettings(){
  $("sOwner").value = CFG.owner || "";
  $("sRepo").value = CFG.repo || "";
  $("sBranch").value = CFG.branch || "main";
  $("sPath").value = CFG.path || "tasks.json";
  $("sToken").value = CFG.token || "";
  $("sMsg").textContent = "";
  $("mSet").classList.add("open");
}
function closeSettings(){ $("mSet").classList.remove("open"); }
function saveSettings(){
  CFG.owner = ($("sOwner").value||"").trim();
  CFG.repo  = ($("sRepo").value||"").trim();
  CFG.branch= ($("sBranch").value||"main").trim() || "main";
  CFG.path  = ($("sPath").value||"tasks.json").trim() || "tasks.json";
  CFG.token = ($("sToken").value||"").trim();
  saveCfg();
  $("sMsg").textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –¢–µ–ø–µ—Ä—å ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª —á–∏—Ç–∞–µ—Ç –æ–±—â–∏–π —Ñ–∞–π–ª, –∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª ‚Äî –ø–∏—à–µ—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω).";
}
async function testSettings(){
  try{
    if(!hasSyncConfig() || !hasToken()) throw new Error("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ owner/repo/branch/path –∏ —Ç–æ–∫–µ–Ω.");
    await loadRemoteSha();
    $("sMsg").innerHTML = `<span style="color:var(--good)">–î–æ—Å—Ç—É–ø –µ—Å—Ç—å ‚úÖ –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.</span>`;
  }catch(e){
    $("sMsg").innerHTML = `<span style="color:var(--bad)">–û—à–∏–±–∫–∞: ${escapeHTML(String(e.message||e))}</span>`;
  }
}

/* ==========================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
========================== */
async function init(){
  $("filePathView").textContent = CFG.path || "tasks.json";

  await loadVacations();
  renderEmployeeSelects();
  renderQuick();
  renderVacControl();

  // defaults for new
  $("nDue").value = addDaysISO(todayISO(), 7);

  // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–Ø", –ø–æ–¥—Å—Ç–∞–≤–∏–º –∫–∞–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤ —Ñ–æ—Ä–º–µ
  const me = localStorage.getItem(LS_ME) || "";
  if(me && employees().includes(me)) $("nOwner").value = me;

  // hooks
  $("btnLoad").addEventListener("click", loadAll);
  $("btnSave").addEventListener("click", saveAll);
  $("btnSummary").addEventListener("click", copySummary);
  $("btnSettings").addEventListener("click", openSettings);

  $("btnAdd").addEventListener("click", addTask);
  $("btnClearNew").addEventListener("click", ()=>{
    $("nTask").value=""; $("nNext").value=""; $("nWarn").style.display="none";
  });
  $("btnNew").addEventListener("click", ()=>{ $("nTask").focus(); });

  $("q").addEventListener("input", renderTable);
  $("fOwner").addEventListener("change", renderTable);
  $("fStatus").addEventListener("change", renderTable);

  $("meSel").addEventListener("change", ()=>{
    const v = $("meSel").value || "";
    if(v) localStorage.setItem(LS_ME, v);
    $("nOwner").value = v || $("nOwner").value;
    renderTable();
  });

  $("nOwner").addEventListener("change", ()=>warnFor($("nOwner").value, $("nDue").value, $("nWarn")));
  $("nDue").addEventListener("change", ()=>warnFor($("nOwner").value, $("nDue").value, $("nWarn")));

  // modal edit
  $("mClose").addEventListener("click", closeEdit);
  $("mSave").addEventListener("click", saveEdit);
  $("mDone").addEventListener("click", doneEdit);
  $("mDel").addEventListener("click", deleteEdit);
  $("mOwner").addEventListener("change", ()=>warnFor($("mOwner").value, $("mDue").value, $("mWarn")));
  $("mDue").addEventListener("change", ()=>warnFor($("mOwner").value, $("mDue").value, $("mWarn")));
  $("mEdit").addEventListener("click", (e)=>{ if(e.target===$("mEdit")) closeEdit(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ closeEdit(); closeSettings(); } });

  // settings modal
  $("sClose").addEventListener("click", closeSettings);
  $("sSave").addEventListener("click", saveSettings);
  $("sTest").addEventListener("click", testSettings);
  $("mSet").addEventListener("click", (e)=>{ if(e.target===$("mSet")) closeSettings(); });

  updateSyncUI();

  // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  await loadAll();
}
init();
</script>
</body>
</html>
